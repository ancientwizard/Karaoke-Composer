var v=Object.defineProperty;var p=(a,t,e)=>t in a?v(a,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):a[t]=e;var h=(a,t,e)=>(p(a,typeof t!="symbol"?t+"":t,e),e);class b{constructor(t){h(this,"lyrics",[]);h(this,"eventLog",[]);h(this,"config");h(this,"silent");this.silent=(t==null?void 0:t.silent)||!1,this.config={syllableWeights:{first:.7,middle:.8,last:2},gaps:{shortPause:100,mediumPause:300,longPause:800},minimums:{syllableDuration:150,wordDuration:200,lineDuration:1e3},...t},this.log("ENGINE_INIT",0,-1,void 0,void 0,"Karaoke Timing Engine initialized")}loadLyrics(t){this.lyrics=[...t],this.eventLog=[],this.log("LYRICS_LOADED",0,-1,void 0,void 0,"Loaded ".concat(t.length," lines"))}assignWordTiming(t,e,i){const s=[];if(!this.isValidPosition(t,e))return this.log("ERROR_INVALID_POSITION",i,t,e),s;const n=this.lyrics[t].words[e],r=this.getPreviousWord(t,e);if(r&&r.word.startTime!==void 0){const l=i-r.word.startTime;this.finalizeWordTiming(r,l,i),s.push({type:"word_end",timestamp:i,lineIndex:r.lineIndex,wordIndex:r.wordIndex,text:r.word.word,expectedDuration:l});const o=this.detectGap(n.word,l);o>this.config.gaps.shortPause&&s.push({type:"phrase_gap",timestamp:i,lineIndex:t,wordIndex:e,expectedDuration:o})}return n.startTime=i,n.endTime=void 0,s.push({type:"word_start",timestamp:i,lineIndex:t,wordIndex:e,text:n.word}),this.log("WORD_ASSIGNED",i,t,e,void 0,n.word),s}finalizeAllTiming(t){const e=[],i=this.findLastTimedWord();if(i&&i.word.startTime!==void 0){const s=this.estimateWordDuration(i.word);this.finalizeWordTiming(i,s,t),e.push({type:"word_end",timestamp:t,lineIndex:i.lineIndex,wordIndex:i.wordIndex,text:i.word.word,expectedDuration:s})}return this.log("TIMING_FINALIZED",t,-1),e}getCurrentPosition(t){for(let e=0;e<this.lyrics.length;e++){const i=this.lyrics[e];for(let s=0;s<i.words.length;s++){const n=i.words[s];if(n.startTime!==void 0){if(n.endTime!==void 0){if(t>=n.startTime&&t<n.endTime){const r=this.findCurrentSyllable(n,t);return{lineIndex:e,wordIndex:s,syllableIndex:r,isActive:!0}}}else if(t>=n.startTime){const r=this.getNextWord(e,s);if(!r||r.word.startTime===void 0||t<r.word.startTime){const l=this.findCurrentSyllable(n,t);return{lineIndex:e,wordIndex:s,syllableIndex:l,isActive:!0}}}}}}return{lineIndex:0,wordIndex:0,syllableIndex:0,isActive:!1}}getEventLog(){return[...this.eventLog]}getStats(){let t=0,e=0,i=0,s=0,n=0;return this.lyrics.forEach(r=>{r.words.forEach(l=>{t++,l.startTime!==void 0&&(e++,l.endTime!==void 0&&(n+=l.endTime-l.startTime)),l.syllables.forEach(o=>{i++,o.startTime!==void 0&&o.endTime!==void 0&&s++})})}),{totalWords:t,timedWords:e,totalSyllables:i,timedSyllables:s,averageWordDuration:e>0?n/e:0,completionPercent:t>0?e/t*100:0,eventCount:this.eventLog.length}}isValidPosition(t,e){return t>=0&&t<this.lyrics.length&&e>=0&&e<this.lyrics[t].words.length}getPreviousWord(t,e){if(e>0)return{lineIndex:t,wordIndex:e-1,word:this.lyrics[t].words[e-1]};if(t>0){const i=this.lyrics[t-1];if(i.words.length>0)return{lineIndex:t-1,wordIndex:i.words.length-1,word:i.words[i.words.length-1]}}return null}getNextWord(t,e){const i=this.lyrics[t];if(e<i.words.length-1)return{lineIndex:t,wordIndex:e+1,word:i.words[e+1]};if(t<this.lyrics.length-1){const s=this.lyrics[t+1];if(s.words.length>0)return{lineIndex:t+1,wordIndex:0,word:s.words[0]}}return null}finalizeWordTiming(t,e,i){const{word:s}=t;s.endTime=i,s.duration=e,this.distributeSyllableTiming(s,e),this.log("WORD_FINALIZED",i,t.lineIndex,t.wordIndex,void 0,"".concat(s.word," (").concat(e,"ms)"))}distributeSyllableTiming(t,e){if(t.syllables.length<=1){t.syllables[0]&&t.startTime!==void 0&&(t.syllables[0].startTime=t.startTime,t.syllables[0].endTime=t.startTime+e,t.syllables[0].duration=e);return}const i=t.syllables.map((l,o)=>o===0?this.config.syllableWeights.first:o===t.syllables.length-1?this.config.syllableWeights.last:this.config.syllableWeights.middle),s=i.reduce((l,o)=>l+o,0),n=i.map(l=>l/s*e);let r=t.startTime;t.syllables.forEach((l,o)=>{l.startTime=r,l.endTime=r+n[o],l.duration=n[o],r=l.endTime,this.log("SYLLABLE_TIMED",l.startTime,-1,-1,o,"".concat(l.syllable," (").concat(n[o].toFixed(1),"ms)"))})}detectGap(t,e){return t.includes(",")||t.includes(";")?this.config.gaps.shortPause:t.includes(".")||t.includes("!")||t.includes("?")?this.config.gaps.mediumPause:e>this.config.minimums.wordDuration*2?this.config.gaps.mediumPause:0}findLastTimedWord(){for(let t=this.lyrics.length-1;t>=0;t--){const e=this.lyrics[t];for(let i=e.words.length-1;i>=0;i--){const s=e.words[i];if(s.startTime!==void 0)return{lineIndex:t,wordIndex:i,word:s}}}return null}estimateWordDuration(t){const e=t.syllables.length;return this.config.minimums.wordDuration+(e-1)*this.config.minimums.syllableDuration}findCurrentSyllable(t,e){if(t.syllables.some(s=>s.startTime!==void 0&&s.endTime!==void 0)){for(let s=0;s<t.syllables.length;s++){const n=t.syllables[s];if(n.startTime!==void 0&&n.endTime!==void 0&&e>=n.startTime&&e<n.endTime)return s}return Math.max(0,t.syllables.length-1)}else{if(t.startTime===void 0||t.syllables.length<=1)return 0;const s=e-t.startTime;for(let n=0;n<t.syllables.length;n++){const r=(n+1)*this.config.minimums.syllableDuration;if(s<r)return Math.max(0,n)}return t.syllables.length-1}}log(t,e,i,s,n,r){const l="[".concat(e.toFixed(0).padStart(6),"ms] ").concat(t.padEnd(20)," L:").concat(i.toString().padStart(2)," W:").concat((s!=null?s:-1).toString().padStart(2)," S:").concat((n!=null?n:-1).toString().padStart(2)," ").concat(r||"");this.silent||console.log(l),this.eventLog.push({type:t,timestamp:e,lineIndex:i,wordIndex:s,syllableIndex:n,text:r})}}const L={word:{minDuration:100,maxDuration:2e3,collisionMargin:50,defaultDuration:500},syllable:{minDuration:50,defaultDuration:200,lastSyllableWeight:2,firstSyllableWeight:.8,weightIncrement:.1},autoTiming:{normalWordSpacing:.6,phraseBreakSpacing:.25,phraseBreakThreshold:3,maxNormalDuration:600,maxPhraseBreakDuration:800,conservativeGapUsage:.7,lineEndingGapUsage:.5},musical:{restDuration:{comma:200,period:800,breath:300,phrase:600},notePatterns:{eighth:125,quarter:250,half:500,whole:1e3},conservativeMultiplier:.7},editor:{pixelThreshold:5,snapThreshold:10,viewportBuffer:100,dragSensitivity:1},validation:{gapTolerance:3,overlapTolerance:3,durationTolerance:1,timingPrecision:1},refresh:{playbackUpdateHz:8,fastModeMultiplier:1.5,dragUpdateHz:60}},c=L;class m{static calculateSyllableWeights(t){return Array.from({length:t},(e,i)=>i===t-1?c.syllable.lastSyllableWeight:c.syllable.firstSyllableWeight+i*c.syllable.weightIncrement)}static isPhraseBreak(t){return t>c.autoTiming.phraseBreakThreshold}static getConservativeDuration(t,e=!1){const i=e?c.autoTiming.lineEndingGapUsage:c.autoTiming.conservativeGapUsage;return t*i}static constrainDuration(t,e=!0){const i=e?c.word.minDuration:c.syllable.minDuration,s=e?c.word.maxDuration:c.word.maxDuration/2;return Math.max(i,Math.min(s,t))}static roundTiming(t){return Math.round(t/c.validation.timingPrecision)*c.validation.timingPrecision}static getPlaybackUpdateInterval(t=!1){return 1e3/(t?c.refresh.playbackUpdateHz*c.refresh.fastModeMultiplier:c.refresh.playbackUpdateHz)}static getDragUpdateInterval(){return 1e3/c.refresh.dragUpdateHz}}function D(a,t,e){const i=[];return a.split(/\s+/).filter(n=>n.length>0).forEach(n=>{const r=n.split("/").filter(d=>d.length>0),l=r.map(d=>({syllable:d})),o=r.join("");i.push({word:o,syllables:l})}),{id:e,lineNumber:t,text:a,words:i}}function w(a,t){const e=new b({silent:!0});e.loadLyrics(a);const i=e.getCurrentPosition(t),s={lineIndex:i.lineIndex,wordIndex:i.wordIndex,syllableIndex:i.syllableIndex,line:void 0,word:void 0,syllable:void 0};if(i.isActive&&i.lineIndex<a.length){const n=a[i.lineIndex];if(s.line=n,i.wordIndex<n.words.length){const r=n.words[i.wordIndex];s.word=r,i.syllableIndex<r.syllables.length&&(s.syllable=r.syllables[i.syllableIndex])}}return s}function P(a,t,e,i,s=500){const n=[...a],r=n[t];if(r&&r.words[e]){const l=r.words[e];if(l.startTime=i,l.endTime=i+s,l.duration=s,l.syllables.forEach(o=>{o.startTime=void 0,o.endTime=void 0,o.duration=void 0}),e>0){const o=r.words[e-1];if(o.startTime!==void 0){const d=i-o.startTime,u=m.getConservativeDuration(d,!1);f(o,o.startTime,u)}}else if(t>0){const o=n[t-1];if(o&&o.words.length>0){const d=o.words[o.words.length-1];if(d.startTime!==void 0){const u=i-d.startTime,g=m.getConservativeDuration(u,!0);f(d,d.startTime,g)}}}W(r)}return n}function f(a,t,e){if(a.syllables.length<=1)a.syllables[0]&&(a.syllables[0].startTime=t,a.syllables[0].endTime=t+e,a.syllables[0].duration=e);else{const i=a.syllables.length,s=c.syllable.minDuration*i;e<s&&(console.warn('⚠️ Word "'.concat(a.word,'" duration (').concat(e,"ms) too short for ").concat(i," syllables. Extending to ").concat(s,"ms")),e=s);const n=m.calculateSyllableWeights(i),r=n.reduce((d,u)=>d+u,0),l=e-s;let o=t;a.syllables.forEach((d,u)=>{const g=c.syllable.minDuration,y=n[u]/r*l,T=m.constrainDuration(g+y,!1);d.startTime=o,d.endTime=o+T,d.duration=T,o=d.endTime})}a.endTime=t+e,a.duration=e}function M(a,t,e,i=500){const s=[...a],n=s[t];if(n&&n.words[e]){const r=n.words[e];r.startTime!==void 0&&r.syllables.some(l=>l.startTime===void 0)&&f(r,r.startTime,i)}return s}function W(a){const t=a.words.filter(e=>e.startTime!==void 0&&e.endTime!==void 0);if(t.length>0){const e=t.map(s=>s.startTime).filter(s=>s!==void 0),i=t.map(s=>s.endTime).filter(s=>s!==void 0);a.startTime=Math.min(...e),a.endTime=Math.max(...i),a.duration=a.endTime-a.startTime}}function I(a){let t=0,e=0,i=0,s=0,n=0;a.forEach(l=>{l.startTime!==void 0&&l.endTime!==void 0&&n++,l.words.forEach(o=>{t++,o.startTime!==void 0&&o.endTime!==void 0&&e++,o.syllables.forEach(d=>{i++,d.startTime!==void 0&&d.endTime!==void 0&&s++})})});const r=i>0?Math.round(s/i*100):0;return{totalLines:a.length,timedLines:n,totalWords:t,timedWords:e,totalSyllables:i,timedSyllables:s,completionPercent:r}}function S(a){const t=a.trim(),e=t.match(/^\[@TITLE:(.+)\]/);if(e)return{type:"title",value:e[1].trim()};const i=t.match(/^\[@AUTHOR:(.+)\]/);if(i)return{type:"author",value:i[1].trim()};const s=t.match(/^\[@CAPTION:(.+)\]/);return s?{type:"caption",value:s[1].trim()}:null}function N(a){if(!a||typeof a!="string")return{lyrics:[],metadata:{}};const t=a.split("\n").map(l=>l.trim()).filter(l=>l.length>0),e=[],i={};let s=1,n=null;t.forEach((l,o)=>{const d=S(l);if(d){const u={id:"metadata-".concat(o),lineNumber:s,text:l,words:[],type:d.type,metadata:{[d.type]:d.value}};d.type==="title"?i.title=d.value:d.type==="author"?i.author=d.value:d.type==="caption"&&(i.captions||(i.captions=[]),i.captions.push(d.value),n=d.value),e.push(u),s++}else{const u=D(l,s,"line-".concat(s));u.type="lyrics",n&&(u.metadata||(u.metadata={}),u.metadata.caption=n,n=null),e.push(u),s++}});const r=e.findIndex(l=>l.type==="title");if(r>0){const l=e.splice(r,1)[0];e.unshift(l),e.forEach((o,d)=>{o.lineNumber=d+1})}return{lyrics:e,metadata:i}}function $(a,t){const e=[...a];for(let i=t;i<e.length;i++){const s=e[i];s.type&&s.type!=="lyrics"||(s.startTime=void 0,s.endTime=void 0,s.duration=void 0,s.words&&s.words.forEach(n=>{n.startTime=void 0,n.endTime=void 0,n.duration=void 0,n.syllables&&n.syllables.forEach(r=>{r.startTime=void 0,r.endTime=void 0,r.duration=void 0})}))}return e}export{m as T,c as a,D as b,$ as c,I as d,P as e,M as f,w as g,N as p};
//# sourceMappingURL=lyricsParser-c2c86582.js.map
