var gt=Object.defineProperty;var bt=(_,t,s)=>t in _?gt(_,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):_[t]=s;var it=(_,t,s)=>(bt(_,typeof t!="symbol"?t+"":t,s),s);import{a as b}from"./lyricsParser-c2c86582.js";import{d as yt,r as B,c as R,l as pt,z as rt,m as lt,k as Mt,a as O,b as w,F as I,e as tt,n as dt,t as T,g as C,o as k,B as ut,j as et,_ as xt}from"./index-d671fee0.js";class L{constructor(t){it(this,"word");this.word={...t},this.validateSyllables()}validateSyllables(){if(this.word.syllables.length===0)throw new Error("Word must have at least one syllable");let t=0;for(const l of this.word.syllables){const r=Math.abs(l.startOffset-t);if(r>b.validation.timingPrecision)throw new Error('Syllable "'.concat(l.text,'" has gap or overlap. Expected startOffset: ').concat(t,", got: ").concat(l.startOffset," (error: ").concat(r,"ms)"));if(l.duration<=0)throw new Error('Syllable "'.concat(l.text,'" must have positive duration, got: ').concat(l.duration));t+=l.duration}const s=this.word.endTime-this.word.startTime,o=t;if(Math.abs(s-o)>b.validation.durationTolerance)throw new Error("Word duration (".concat(s,"ms) doesn't match total syllable duration (").concat(o,"ms)"))}getWordData(){return{...this.word}}getWordDuration(){return this.word.endTime-this.word.startTime}getAbsoluteSyllables(){return this.word.syllables.map(t=>({text:t.text,startTime:this.word.startTime+t.startOffset,endTime:this.word.startTime+t.startOffset+t.duration}))}moveWord(t){const s=this.getWordDuration();return new L({...this.word,startTime:t,endTime:t+s})}resizeWordEnd(t){if(t<=this.word.startTime)throw new Error("Word end time must be after start time");const s=t-this.word.startTime,o=[...this.word.syllables];if(o.length===1)o[0]={...o[0],duration:s};else{const l=o.length-1,r=o[l].startOffset,m=s-r;if(m<=1)throw new Error("Resizing would make last syllable have zero or negative duration");o[l]={...o[l],duration:m}}return new L({...this.word,endTime:t,syllables:o})}resizeWordStart(t){if(t>=this.word.endTime)throw new Error("Word start time must be before end time");const s=this.word.endTime-t,o=[...this.word.syllables];if(o.length===1)o[0]={...o[0],startOffset:0,duration:s};else{const l=o[0].duration,r=s-(this.getWordDuration()-l);if(r<=1)throw new Error("Resizing would make first syllable have zero or negative duration");const m=l-r;o[0]={...o[0],startOffset:0,duration:r};for(let u=1;u<o.length;u++)o[u]={...o[u],startOffset:o[u].startOffset-m}}return new L({...this.word,startTime:t,syllables:o})}moveAndResize(t,s){if(t>=s)throw new Error("Word start time must be before end time");return this.moveWord(t).resizeWordEnd(s)}adjustSyllableBoundary(t,s){if(t<0||t>=this.word.syllables.length-1)throw new Error("Can only adjust boundaries between syllables");const o=s-this.word.startTime;if(o<=this.word.syllables[t].startOffset||o>=this.word.syllables[t+1].startOffset+this.word.syllables[t+1].duration)throw new Error("New syllable boundary is outside valid range");const l=[...this.word.syllables],r=l[t],m=l[t+1],u=o-r.startOffset;l[t]={...r,duration:u};const g=m.startOffset+m.duration;return l[t+1]={...m,startOffset:o,duration:g-o},new L({...this.word,syllables:l})}static fromAbsoluteSyllables(t,s,o,l,r){if(r.length===0)throw new Error("Must have at least one syllable");const m=[];let u=o;for(let c=0;c<r.length;c++){const p=r[c],E=c===r.length-1;let x=Math.round(p.startTime),z=Math.round(p.endTime);if(Math.abs(x-u)<=b.validation.gapTolerance&&(x=u),z<=x){const G=Math.max(b.validation.timingPrecision,b.syllable.minDuration/1e3);z=x+G}E&&(z=Math.round(l)),m.push({text:p.text,startTime:x,endTime:z}),u=z}const g=[];let P=0;for(const c of m){const p=c.endTime-c.startTime,E=Math.max(p,b.validation.timingPrecision);g.push({text:c.text,startOffset:P,duration:E}),P+=E}const y=g.reduce((c,p)=>c+p.duration,0),W=Math.round(o)+y,S=Math.round(l)-Math.round(o);return Math.abs(y-S)>b.validation.durationTolerance,new L({id:t,text:s,startTime:Math.round(o),endTime:W,syllables:g})}static fromSecondsData(t,s,o,l,r,m=1.2){const u=Math.round(o*1e3),g=Math.round(l*1e3);return L.createWeightedSyllables(t,s,u,g,r,m)}toSecondsData(){const t=this.getAbsoluteSyllables();return{word:{id:this.word.id,text:this.word.text,startTime:this.word.startTime/1e3,endTime:this.word.endTime/1e3},syllables:t.map(s=>({text:s.text,startTime:s.startTime/1e3,endTime:s.endTime/1e3}))}}static createEvenSyllables(t,s,o,l,r){const m=Math.round(l-o),u=Math.floor(m/r.length),g=m%r.length,P=[];let y=0;return r.forEach((W,S)=>{const c=u+(S<g?1:0);P.push({text:W,startOffset:y,duration:c}),y+=c}),new L({id:t,text:s,startTime:Math.round(o),endTime:Math.round(l),syllables:P})}static createWeightedSyllables(t,s,o,l,r,m=1.2){const u=Math.round(l-o),g=r.map((c,p)=>p===r.length-1?m:1),P=g.reduce((c,p)=>c+p,0),y=[];let W=0,S=0;return r.forEach((c,p)=>{let E;p===r.length-1?E=u-S:(E=Math.round(g[p]/P*u),S+=E),y.push({text:c,startOffset:W,duration:E}),W+=E}),new L({id:t,text:s,startTime:Math.round(o),endTime:Math.round(l),syllables:y})}}const Wt={class:"word-timing-editor"},Dt=["onMousedown"],St={class:"word-text"},Et=["onMousedown"],$t=["onMousedown"],Ot=["title","onMousedown"],kt={key:0,class:"debug-panel"},_t={key:0},zt={key:1,class:"selected-word-debug"},Pt={class:"word-timing-summary"},Bt={key:0,class:"timing-info"},Ft={key:1,class:"syllable-durations"},Lt=yt({__name:"WordTimingEditor",props:{words:{},duration:{},viewStart:{default:0},viewEnd:{default:void 0},showDebug:{type:Boolean,default:!1},showBackground:{type:Boolean,default:!1},showBorder:{type:Boolean,default:!1}},emits:["update:words","select-word"],setup(_,{emit:t}){const s=_,o=t,l=B(),r=B(null),m=B(!1),u=B(null),g=B("move"),P=B(0),y=B(0),W=B(0),S=B(800),c=R(()=>s.viewEnd||s.duration),p=R(()=>c.value-s.viewStart),E=R(()=>S.value/p.value),x=R(()=>s.words.filter(v=>{if(v.startTime===0&&v.endTime===0)return!1;const D=v.startTime,i=v.endTime,n=s.viewStart-.02,f=c.value+.02;return D>=n&&i<=f})),z=e=>(e-s.viewStart)*E.value,G=e=>{if(e.startTime===0&&e.endTime===0){const M=s.words.filter(F=>F.startTime===0&&F.endTime===0).findIndex(F=>F.id===e.id),d=Math.max(e.text.length*8+20,60),N=M*(d+5);return{left:"".concat(N,"px"),width:"".concat(d,"px")}}const a=z(e.startTime),h=z(e.endTime)-a,D=Math.max(0,a),i=Math.max(h,24),n=S.value-24,f=Math.min(D,n),$=Math.min(i,S.value-f);return{left:"".concat(f,"px"),width:"".concat($,"px")}},st=(e,a)=>{if(!e.syllables||a>=e.syllables.length-1)return{display:"none"};const v=z(e.startTime),h=z(e.syllables[a].endTime),D=z(e.endTime)-v,i=h-v,n=Math.max(6,Math.min(i,D-6));return{left:"".concat(n,"px"),display:D>20?"block":"none"}},mt=(e,a)=>{a.preventDefault(),r.value=e.id,o("select-word",e.id)},j=B({}),V=e=>Math.max(b.word.minDuration/1e3,e.endTime-e.startTime),q=e=>e.endTime-e.startTime,ot=e=>{if(e.endTime<=e.startTime){const a=e.startTime+b.word.minDuration/1e3;return{...e,endTime:a}}return e},ct=(e,a)=>({...e,endTime:e.startTime+a}),ft=(e,a)=>{const v=V(e);return{...e,startTime:a,endTime:a+v}},H=(e,a,v,h)=>{if(v.preventDefault(),v.stopPropagation(),m.value=!0,u.value=a.id,g.value=e,P.value=v.clientX,e==="move"?y.value=a.startTime:e==="resize"?y.value=a.endTime:e==="syllable"&&typeof h=="number"&&a.syllables&&(y.value=a.syllables[h].endTime,W.value=h,console.log('ðŸŽ¯ Starting syllable drag: word="'.concat(a.text,'", syllable=').concat(h,", boundary=").concat(y.value.toFixed(3),"s"))),a.syllables&&a.syllables.length>1){const D=V(a);j.value[a.id]=a.syllables.map(i=>q(i)/D)}r.value=a.id,o("select-word",a.id),document.addEventListener("mousemove",K),document.addEventListener("mouseup",Q),document.body.style.cursor=e==="move"?"grabbing":"col-resize",document.body.style.userSelect="none"},K=e=>{if(!m.value||!u.value)return;const v=(e.clientX-P.value)/E.value,h=s.words.findIndex(M=>M.id===u.value);if(h===-1)return;const D=[...s.words],i={...D[h]},n=h>0?s.words[h-1]:null,f=h<s.words.length-1?s.words[h+1]:null;if(g.value==="move"){const M=V(i);let d=Math.max(0,y.value+v);console.log('ðŸ”§ Moving "'.concat(i.text,'": original=').concat(i.startTime,"-").concat(i.endTime," (").concat(M,"s), newStart=").concat(d));const N=d<i.startTime,F=d>i.startTime,X=n&&n.endTime>i.startTime,Y=f&&f.startTime<i.endTime;if(console.log("ðŸ”§ Collision check: movingLeft=".concat(N,", movingRight=").concat(F,", prevOverlapped=").concat(X,", nextOverlapped=").concat(Y)),n&&!X)d=Math.max(d,n.endTime+b.word.collisionMargin/1e3);else if(n&&X&&N){const A=Math.max(0,n.startTime-M-b.word.collisionMargin/1e3);d=Math.max(d,A)}if(f&&!Y){const A=f.startTime-M-b.word.collisionMargin/1e3;d=Math.min(d,A)}else if(f&&Y&&F){const A=f.endTime+b.word.collisionMargin/1e3;d=Math.min(d,A)}const nt=b.editor.viewportBuffer/1e3,vt=c.value-M-nt;d=Math.min(d,vt),d=Math.max(d,s.viewStart-nt);const J=ft(i,d);if(console.log("ðŸ”§ After moveWord: ".concat(J.startTime,"-").concat(J.endTime)),i.startTime=J.startTime,i.endTime=J.endTime,i.syllables&&j.value[i.id]){const A=j.value[i.id];let Z=d;i.syllables=i.syllables.map((ht,wt)=>{const at=A[wt]*M,Tt={...ht,startTime:Z,endTime:Z+at};return Z+=at,Tt})}}else if(g.value==="resize"){let M=Math.max(i.startTime+b.word.minDuration/1e3,y.value+v),d=M-i.startTime;if(f){const X=f.startTime-i.startTime-b.word.collisionMargin/1e3;d=Math.min(d,X),M=i.startTime+d}const N=c.value+b.editor.viewportBuffer/1e3;M>N&&(d=N-i.startTime,M=N);const F=ct(i,d);i.endTime=F.endTime}else if(g.value==="syllable"&&i.syllables&&W.value<i.syllables.length-1){const M=b.syllable.minDuration/1e3/2,d=Math.max(i.syllables[W.value].startTime+M,Math.min(i.syllables[W.value+1].endTime-M,y.value+v));console.log('ðŸ”§ Syllable boundary: "'.concat(i.syllables[W.value].text,'" | "').concat(i.syllables[W.value+1].text,'" â†’ ').concat(d.toFixed(3),"s")),i.syllables[W.value].endTime=d,i.syllables[W.value+1].startTime=d}const $=ot(i);D[h]=$;const U=D.map(ot);o("update:words",U)},Q=()=>{u.value&&j.value[u.value]&&delete j.value[u.value],m.value=!1,u.value=null,document.removeEventListener("mousemove",K),document.removeEventListener("mouseup",Q),document.body.style.cursor="",document.body.style.userSelect=""};return pt(async()=>{await rt();const e=()=>{if(l.value){const a=l.value.clientWidth;a>0&&(S.value=a)}};e(),setTimeout(e,100),window.addEventListener("resize",e),lt(()=>{window.removeEventListener("resize",e)})}),Mt([()=>s.viewStart,()=>s.viewEnd,()=>s.duration],()=>{rt(()=>{if(l.value){const e=l.value.clientWidth;e>0&&e!==S.value&&(S.value=e)}})},{flush:"post"}),lt(()=>{document.removeEventListener("mousemove",K),document.removeEventListener("mouseup",Q)}),(e,a)=>{var v,h,D,i;return k(),O("div",Wt,[w("div",{class:dt(["timeline-track",{"with-background":_.showBackground,"with-border":_.showBorder}]),ref_key:"timelineTrack",ref:l},[a[0]||(a[0]=w("div",{class:"timeline-baseline"},null,-1)),(k(!0),O(I,null,tt(x.value,n=>(k(),O("div",{key:n.id,class:dt(["word-car",{selected:r.value===n.id,dragging:m.value&&u.value===n.id,untimed:n.startTime===0&&n.endTime===0}]),style:ut(G(n)),onMousedown:f=>mt(n,f)},[w("div",St,T(n.text),1),w("div",{class:"hotspot hotspot-move",title:"Drag to move word",onMousedown:et(f=>H("move",n,f),["stop"])},null,40,Et),w("div",{class:"hotspot hotspot-resize-end",title:"Drag to adjust end time",onMousedown:et(f=>H("resize",n,f),["stop"])},null,40,$t),n.syllables&&n.syllables.length>1?(k(!0),O(I,{key:0},tt(n.syllables.slice(0,-1),(f,$)=>(k(),O("div",{key:"syllable-".concat($),class:"hotspot hotspot-syllable-divider",style:ut(st(n,$)),title:"Adjust syllable ".concat($+1,"/").concat($+2," boundary"),onMousedown:et(U=>H("syllable",n,U,$),["stop"])},null,44,Ot))),128)):C("",!0)],46,Dt))),128))],2),_.showDebug?(k(),O("div",kt,[a[4]||(a[4]=w("h4",null,"Word Timing Editor Debug",-1)),w("p",null,"Timeline Duration: "+T(_.duration.toFixed(2))+"s",1),w("p",null," View Window: "+T(s.viewStart.toFixed(2))+"s - "+T(c.value.toFixed(2))+"s ("+T(p.value.toFixed(2))+"s span) ",1),w("p",null,"Pixels/Second: "+T(E.value.toFixed(1)),1),w("p",null,"Track Width: "+T(S.value)+"px",1),w("p",null,"Total Words: "+T(s.words.length)+" | Visible: "+T(x.value.length),1),w("p",null,"Selected Word: "+T(r.value||"None"),1),w("p",null,"Drag State: "+T(m.value?"".concat(g.value," on ").concat(u.value):"None"),1),m.value?(k(),O("p",_t,"Drag Start Time: "+T(y.value.toFixed(3))+"s",1)):C("",!0),r.value?(k(),O("div",zt,[a[3]||(a[3]=w("strong",null,"Selected Word Details:",-1)),w("div",Pt,[x.value.find(n=>n.id===r.value)?(k(),O("p",Bt,' Word: "'+T((v=x.value.find(n=>n.id===r.value))==null?void 0:v.text)+'" | Start: '+T((h=x.value.find(n=>n.id===r.value))==null?void 0:h.startTime.toFixed(3))+"s | Duration: "+T(V(x.value.find(n=>n.id===r.value)).toFixed(3))+"s ",1)):C("",!0),(D=x.value.find(n=>n.id===r.value))!=null&&D.syllables?(k(),O("div",Ft,[a[1]||(a[1]=w("strong",null,"Syllable Durations:",-1)),(k(!0),O(I,null,tt((i=x.value.find(n=>n.id===r.value))==null?void 0:i.syllables,(n,f)=>(k(),O("div",{key:f,class:"syllable-info"},' "'+T(n.text)+'": '+T(q(n).toFixed(3))+"s ("+T((q(n)/V(x.value.find($=>$.id===r.value))*100).toFixed(1))+"%) ",1))),128))])):C("",!0)]),w("details",null,[a[2]||(a[2]=w("summary",null,"Raw JSON Data",-1)),w("pre",null,T(JSON.stringify(x.value.find(n=>n.id===r.value),null,2)),1)])])):C("",!0)])):C("",!0)])}}});const jt=xt(Lt,[["__scopeId","data-v-a7e70df8"]]);export{L as R,jt as W};
//# sourceMappingURL=WordTimingEditor-d2295c43.js.map
