var ct=Object.defineProperty;var mt=(n,o,s)=>o in n?ct(n,o,{enumerable:!0,configurable:!0,writable:!0,value:s}):n[o]=s;var le=(n,o,s)=>(mt(n,typeof o!="symbol"?o+"":o,s),s);import{d as Pe,r as E,c as O,a as v,b as e,n as G,t as b,F as ne,e as de,g as q,i as V,z as Se,o as c,w as Ze,h as tt,A as He,_ as Ue,k as je,B as ze,l as ot,f as vt,C as ft,p as lt,m as gt,q as $e,s as it,j as yt,D as bt,x as ht,y as pt,u as wt}from"./index-d671fee0.js";import{T as rt,a as re,b as st,c as dt,p as kt,g as at,d as Tt,f as Qe,e as xt}from"./lyricsParser-c2c86582.js";import{a as $t}from"./audioStorageService-d4372df5.js";import{W as St,R as Mt}from"./WordTimingEditor-d2295c43.js";class Ct{constructor(){le(this,"audio",null);le(this,"audioContext",null);le(this,"source",null);le(this,"analyser",null);le(this,"gainNode",null);le(this,"isInitialized",!1);le(this,"updateTimer",null);le(this,"fastMode",!1);le(this,"playbackState",{isPlaying:!1,currentTime:0,duration:0,volume:1,playbackRate:1,isLoaded:!1});le(this,"timeUpdateCallback");le(this,"playbackStateCallback");this.initializeAudioContext()}async initializeAudioContext(){try{this.audioContext&&this.audioContext.state==="closed"&&(this.audioContext=null,this.analyser=null,this.gainNode=null,this.source=null,this.isInitialized=!1),(!this.audioContext||this.audioContext.state==="closed")&&(this.audioContext=new AudioContext,this.analyser=this.audioContext.createAnalyser(),this.gainNode=this.audioContext.createGain(),this.analyser.fftSize=2048,this.analyser.connect(this.audioContext.destination),this.gainNode.connect(this.analyser),this.isInitialized=!0,console.log("Audio context initialized successfully")),this.audioContext.state==="suspended"&&(await this.audioContext.resume(),console.log("Audio context resumed"))}catch(o){console.error("Failed to initialize audio context:",o)}}async loadAudioFile(o){try{if(await this.initializeAudioContext(),this.audio&&(this.audio.pause(),this.audio.src=""),this.audio=new Audio,this.setupAudioEventListeners(),o.file){const f=URL.createObjectURL(o.file);this.audio.src=f}else if(o.url)this.audio.src=o.url;else throw new Error("No audio file or URL provided");if(this.isInitialized&&this.audioContext&&this.gainNode)try{this.source&&this.source.disconnect(),this.source=this.audioContext.createMediaElementSource(this.audio),this.source.connect(this.gainNode),console.log("Audio source connected to Web Audio API")}catch(f){console.warn("Web Audio API connection failed, falling back to basic audio:",f)}await new Promise((f,t)=>{const h=()=>{this.audio.removeEventListener("canplaythrough",h),this.audio.removeEventListener("error",l),f()},l=u=>{this.audio.removeEventListener("canplaythrough",h),this.audio.removeEventListener("error",l),t(u)};this.audio.addEventListener("canplaythrough",h),this.audio.addEventListener("error",l),this.audio.load()}),this.playbackState.isLoaded=!0;const s=await this.detectAudioDuration(o);return this.playbackState.duration=s,this.updatePlaybackState(),!0}catch(s){return console.error("Failed to load audio file:",s),this.playbackState.isLoaded=!1,this.updatePlaybackState(),!1}}setupAudioEventListeners(){this.audio&&(this.audio.addEventListener("timeupdate",()=>{this.playbackState.currentTime=this.audio.currentTime*1e3,this.updatePlaybackState(),this.timeUpdateCallback&&this.timeUpdateCallback(this.playbackState.currentTime)}),this.audio.addEventListener("play",()=>{this.playbackState.isPlaying=!0,this.updatePlaybackState()}),this.audio.addEventListener("pause",()=>{this.playbackState.isPlaying=!1,this.updatePlaybackState()}),this.audio.addEventListener("ended",()=>{this.playbackState.isPlaying=!1,this.playbackState.currentTime=0,this.updatePlaybackState()}),this.audio.addEventListener("loadedmetadata",()=>{this.playbackState.duration=this.audio.duration*1e3,this.updatePlaybackState()}))}async play(){if(!(!this.audio||!this.playbackState.isLoaded))try{await this.initializeAudioContext(),this.audioContext&&this.audioContext.state==="suspended"&&(await this.audioContext.resume(),console.log("Audio context resumed for playback")),await this.audio.play(),this.playbackState.isPlaying=!0,this.startUpdateTimer(),this.updatePlaybackState(),console.log("Audio playback started successfully")}catch(o){throw console.error("Failed to play audio:",o),o}}pause(){this.audio&&(this.audio.pause(),this.stopUpdateTimer())}stop(){this.audio&&(this.audio.pause(),this.audio.currentTime=0)}seek(o){this.audio&&this.playbackState.isLoaded&&(this.audio.currentTime=o/1e3,this.playbackState.currentTime=o,this.updatePlaybackState(),this.timeUpdateCallback&&this.timeUpdateCallback(o))}setVolume(o){this.audio&&(this.audio.volume=Math.max(0,Math.min(1,o)),this.playbackState.volume=this.audio.volume),this.gainNode&&(this.gainNode.gain.value=this.playbackState.volume),this.updatePlaybackState()}setPlaybackRate(o){this.audio&&(this.audio.playbackRate=Math.max(.25,Math.min(4,o)),this.playbackState.playbackRate=this.audio.playbackRate),this.updatePlaybackState()}getPlaybackState(){return{...this.playbackState}}onTimeUpdate(o){this.timeUpdateCallback=o}onPlaybackStateChange(o){this.playbackStateCallback=o}setFastMode(o){this.fastMode=o,this.playbackState.isPlaying&&(this.stopUpdateTimer(),this.startUpdateTimer());const s=o?"12Hz":"8Hz",f=o?"~83ms":"~125ms";console.log("🔄 Refresh rate: ".concat(s," (").concat(f," intervals) - ").concat(o?"FAST MODE":"Normal mode"))}toggleFastMode(){this.setFastMode(!this.fastMode)}getFastMode(){return this.fastMode}startUpdateTimer(){this.updateTimer&&clearInterval(this.updateTimer);const o=rt.getPlaybackUpdateInterval(this.fastMode);this.updateTimer=window.setInterval(()=>{if(this.audio&&this.playbackState.isPlaying){const s=this.audio.currentTime*1e3;this.playbackState.currentTime=s,this.timeUpdateCallback&&this.timeUpdateCallback(s)}},o)}stopUpdateTimer(){this.updateTimer&&(clearInterval(this.updateTimer),this.updateTimer=null)}updatePlaybackState(){this.playbackStateCallback&&this.playbackStateCallback({...this.playbackState})}getFrequencyData(){if(!this.analyser)return null;const o=new Uint8Array(this.analyser.frequencyBinCount);return this.analyser.getByteFrequencyData(o),o}getTimeDomainData(){if(!this.analyser)return null;const o=new Uint8Array(this.analyser.frequencyBinCount);return this.analyser.getByteTimeDomainData(o),o}async generateWaveformData(o=1e3){if(!this.audio||!this.audioContext)return null;try{const f=await(await fetch(this.audio.src)).arrayBuffer(),h=(await this.audioContext.decodeAudioData(f)).getChannelData(0),l=Math.floor(h.length/o),u=[];for(let d=0;d<o;d++){const M=d*l,T=M+l;let x=0;for(let p=M;p<T;p++)x=Math.max(x,Math.abs(h[p]));u.push(x)}return u}catch(s){return console.error("Failed to generate waveform data:",s),null}}async detectAudioDuration(o){if(o.duration&&o.duration>0)return console.log("✅ Using stored duration:",o.duration/1e3,"seconds"),o.duration;if(this.audio&&isFinite(this.audio.duration)&&this.audio.duration>0)return console.log("📏 Duration from HTML5 audio:",this.audio.duration,"seconds"),this.audio.duration*1e3;console.log("⏳ HTML5 duration invalid, using Web Audio API to detect duration...");try{const s=await this.fileToArrayBuffer(o);if(!this.audioContext)throw new Error("AudioContext not initialized");const f=await this.audioContext.decodeAudioData(s),t=f.duration*1e3;return console.log("🎵 Duration detected via Web Audio API:",f.duration,"seconds"),t}catch(s){return console.error("❌ Failed to detect audio duration:",s),console.warn("⚠️ Using fallback duration of 3 minutes - waveform scrolling may not work correctly"),18e4}}async fileToArrayBuffer(o){if(o.file)return await o.file.arrayBuffer();if(o.url)return await(await fetch(o.url)).arrayBuffer();throw new Error("No audio file or URL available")}dispose(){this.audio&&(this.audio.pause(),this.audio.src=""),this.source&&this.source.disconnect(),this.audioContext&&this.audioContext.close(),this.timeUpdateCallback=void 0,this.playbackStateCallback=void 0}}const J=new Ct;function ut(n,o,s){const f=/[,;]$/.test(n),t=/[.!?]$/.test(n),h=o?/^[A-Z]/.test(o):!1;return t||h?{hasRest:!0,restType:"phrase",estimatedRestDuration:re.musical.restDuration.period}:f?{hasRest:!0,restType:"comma",estimatedRestDuration:re.musical.restDuration.comma}:s&&s>1e3?{hasRest:!0,restType:"breath",estimatedRestDuration:Math.min(s*.3,re.musical.restDuration.breath)}:{hasRest:!1,restType:"breath",estimatedRestDuration:0}}function Lt(n,o,s={}){const{estimatedBeatDuration:f=500}=s,t={eighth:f/2,quarter:f,half:f*2,whole:f*4};if(n===1)return o>t.half?[{type:"half",duration:t.half}]:o>t.quarter?[{type:"quarter",duration:t.quarter}]:[{type:"eighth",duration:t.eighth}];if(n===2)return o/2>t.quarter?[{type:"quarter",duration:t.quarter},{type:"quarter",duration:t.quarter}]:[{type:"eighth",duration:t.eighth},{type:"quarter",duration:t.quarter}];if(n===3)return[{type:"eighth",duration:t.eighth},{type:"eighth",duration:t.eighth},{type:"quarter",duration:t.quarter}];const l=o/n>t.quarter?"quarter":"eighth";return Array(n).fill(null).map(()=>({type:l,duration:t[l]}))}function nt(n,o,s,f,t={},h=!1,l=!1){if(n.syllables.length===0)return;const u=ut(n.word,f,s);let d=s-u.estimatedRestDuration;if(l&&n.endTime!==void 0&&n.startTime!==void 0){const x=n.endTime-n.startTime;d=Math.min(d,x),console.log('🎵 Constraining "'.concat(n.word,'" to existing duration: ').concat(x,"ms"))}const M=Lt(n.syllables.length,d,t);let T=o;n.syllables.forEach((x,p)=>{const F=M[p]||M[M.length-1];x.startTime=T,x.endTime=T+F.duration,x.duration=F.duration,T=x.endTime}),n.startTime=o,l?console.log('🎵 Preserving word boundaries for "'.concat(n.word,'": ').concat(n.startTime,"-").concat(n.endTime)):(n.endTime=T,n.duration=T-o),h||console.log('🎵 Musical timing: "'.concat(n.word,'" uses ').concat(n.duration,"ms of ").concat(s,"ms available")+(u.hasRest?" (".concat(u.estimatedRestDuration,"ms rest reserved)"):""))}function _t(n){let o=0,s=0,f=0;for(const d of n)for(let M=0;M<d.words.length;M++){const T=d.words[M];if(T.startTime!==void 0&&T.endTime!==void 0){o++,s+=T.endTime-T.startTime;const x=d.words[M+1];if((x==null?void 0:x.startTime)!==void 0){const p=x.startTime-T.endTime;ut(T.word,x.word,p).hasRest&&f++}}}const t=o>0?s/o:500,h=o>0?6e4/t:120,l=Math.max(80,Math.min(200,h));let u="poor";return o>10&&f>2&&(u="good"),o>20&&f>5&&(u="excellent"),{totalWords:o,avgWordDuration:t,estimatedBPM:l,detectedRests:f,timingQuality:u}}function At(n,o={}){const{preserveWordTiming:s=!0,onlyProcessUntimedSyllables:f=!0}=o,t=_t(n);console.log("🎵 Song Analysis: ".concat(t.totalWords," words, ").concat(t.estimatedBPM.toFixed(0)," BPM, ").concat(t.detectedRests," rests (").concat(t.timingQuality," quality)"));const h={bpm:t.estimatedBPM,timeSignature:[4,4],estimatedBeatDuration:6e4/t.estimatedBPM};for(const l of n)for(let u=0;u<l.words.length;u++){const d=l.words[u];if(d.startTime!==void 0){if(f&&d.syllables.some(F=>F.startTime!==void 0)){console.log('🎵 Skipping "'.concat(d.word,'" - already has syllable timing'));continue}let M=1e3;const T=l.words[u+1];(T==null?void 0:T.startTime)!==void 0&&(M=T.startTime-d.startTime);const x=T==null?void 0:T.word;if(s&&d.endTime!==void 0){const p=d.endTime-d.startTime;nt(d,d.startTime,p,x,h,!1,!0)}else{const p=Math.min(M*re.musical.conservativeMultiplier,re.autoTiming.maxPhraseBreakDuration);nt(d,d.startTime,p,x,h,!1,!1)}}}return t}function Pt(n){let o=0;for(const s of n)for(const f of s.words)f.syllables.forEach(t=>{t.startTime!==void 0&&o++,t.startTime=void 0,t.endTime=void 0,t.duration=void 0});console.log("🔄 Reset syllable timing for ".concat(o," syllables"))}function Dt(){function n(s){const f=[],t=[],h=[];let l=0,u=0;const d=[];if(s.forEach((p,F)=>{p.words.forEach((W,U)=>{l++,W.startTime!==void 0&&W.endTime!==void 0&&(u++,d.push({...W,lineIndex:F,wordIndex:U}))})}),u===0)return{overlaps:[],totalWords:l,timedWords:u,smallGaps:[],sequenceViolations:[],summary:"No timed words found.",hasIssues:!1};s.forEach(p=>{const F=p.words.filter(W=>W.startTime!==void 0&&W.endTime!==void 0);for(let W=0;W<F.length-1;W++){const U=F[W],j=F[W+1];U.startTime>j.startTime&&h.push({word1:U.word,word2:j.word,issue:'"'.concat(U.word,'" starts at ').concat(U.startTime,'ms but comes before "').concat(j.word,'" at ').concat(j.startTime,"ms")})}}),d.sort((p,F)=>(p.startTime||0)-(F.startTime||0));for(let p=0;p<d.length-1;p++){const F=d[p],W=d[p+1];if(F.endTime>W.startTime){const U=W.startTime,j=Math.min(F.endTime,W.endTime),H=j-U;f.push({word1:F,word2:W,overlapStart:U,overlapEnd:j,overlapDuration:H})}}for(let p=0;p<d.length-1;p++){const F=d[p],W=d[p+1],U=W.startTime-F.endTime;U>=0&&U<50&&t.push({word1:F.word,word2:W.word,gap:U})}const M=f.length>0||t.length>3||h.length>0,T=f.length+t.length+h.length;let x="";return h.length>0?x="🚨 Critical: ".concat(h.length," words out of sequence! This breaks timing order."):f.length===0&&t.length<=3?x="✅ Clean timing: ".concat(u," words, good spacing"):x="⚠️ Found ".concat(T," spacing issues (").concat(f.length," overlaps, ").concat(t.length," tight gaps) - may affect editing"),{overlaps:f,totalWords:l,timedWords:u,smallGaps:t,sequenceViolations:h,summary:x,hasIssues:M}}function o(s){console.log("🔧 Starting timing overlap fix...");const f=[];let t=0;const h=[];s.forEach((u,d)=>{u.words.forEach((M,T)=>{M.startTime!==void 0&&M.endTime!==void 0&&h.push({word:M,lineIndex:d,wordIndex:T})})}),console.log("🔍 Found ".concat(h.length," timed words to check")),h.sort((u,d)=>(u.word.startTime||0)-(d.word.startTime||0));const l=50;for(let u=0;u<h.length-1;u++){const d=h[u],M=h[u+1],T=d.word,x=M.word,p=x.startTime-T.endTime;if(p<l){const W=T.endTime,U=x.startTime-l;p<0?console.log('🔧 Fixing overlap: "'.concat(T.word,'" (').concat(W,'ms) → "').concat(x.word,'" (').concat(x.startTime,"ms)")):console.log('🔧 Fixing tight spacing: "'.concat(T.word,'" → "').concat(x.word,'" (').concat(p,"ms gap → ").concat(l,"ms gap)")),console.log('   Adjusting "'.concat(T.word,'" end time: ').concat(W,"ms → ").concat(U,"ms")),T.endTime=U,T.duration=T.endTime-T.startTime;const j=p<0?"overlap":"tight spacing";if(f.push("Fixed ".concat(j,' "').concat(T.word,'": ').concat(W,"ms → ").concat(T.endTime,"ms")),t++,T.syllables&&T.syllables.length>0){const H=T.duration;let X=T.startTime;T.syllables.forEach(C=>{const $=H/T.syllables.length;C.startTime=X,C.endTime=X+$,C.duration=$,X=C.endTime}),console.log("   Updated ".concat(T.syllables.length,' syllables for "').concat(T.word,'"'))}}}return console.log("✅ Fixed ".concat(t," overlaps")),{fixCount:t,details:f}}return{analyzeTimingOverlaps:n,fixTimingOverlaps:o}}const Et={class:"lyrics-editor"},Ft={class:"card"},Wt={class:"card-header d-flex justify-content-between align-items-center"},It={class:"editor-controls"},Rt={class:"card-body p-0"},Bt=["onClick"],Nt={class:"line-number"},jt={class:"timing-display"},zt={key:0,class:"text-success"},Ut={key:1,class:"text-info"},qt={key:2,class:"text-muted"},Vt={class:"lyric-text-container"},Ht=["onUpdate:modelValue"],Kt=["onUpdate:modelValue"],Ot=["onDblclick"],Gt={key:0,class:"metadata-display"},Xt={key:1,class:"words-display"},Jt={key:2,class:"empty-text"},Qt={class:"line-actions"},Zt=["onClick"],Yt=["onClick"],ei={key:0,class:"empty-state text-center py-4"},ti={class:"card-footer"},ii={class:"row align-items-center"},si={class:"col-sm-6"},ai={class:"text-muted"},ni={class:"col-sm-6 text-end"},oi={key:0,class:"text-muted"},li={key:1,class:"text-muted"},ri=Pe({__name:"LyricsEditor",props:{lyrics:{},currentLine:{},currentWord:{},isTimingMode:{type:Boolean}},emits:["line-select","lyrics-update"],setup(n,{emit:o}){const s=n,f=o,t=E(-1),h=E(),l=E(),u=O(()=>s.lyrics.filter(C=>C.startTime!==void 0).length),d=C=>C.type!==void 0&&C.type!=="lyrics",M=C=>{f("line-select",C)},T=()=>{const C=st("",s.lyrics.length+1,"line-".concat(Date.now())),$=[...s.lyrics,C];j($),f("lyrics-update",$),Se(()=>{p($.length-1)})},x=C=>{if(confirm("Are you sure you want to delete this line?")){const $=s.lyrics.filter((_,A)=>A!==C);j($),f("lyrics-update",$)}},p=C=>{s.isTimingMode||(t.value=C,Se(()=>{var _;const $=(_=l.value)==null?void 0:_[0];$&&($.focus(),$.select())}))},F=()=>{if(t.value>=0){const C=[...s.lyrics],$=C[t.value];if($){const _=st($.text,$.lineNumber,$.id);_.startTime=$.startTime,_.endTime=$.endTime,_.duration=$.duration,C[t.value]=_,f("lyrics-update",C)}}t.value=-1},W=()=>{t.value=-1},U=C=>{const $=s.lyrics.length-C,_=$===1?"Clear timing for this line?":"Clear timing for this line and ".concat($-1," lines after it?\n\nThis prevents timing inconsistencies by clearing all subsequent timing.");if(confirm(_)){const A=dt(s.lyrics,C);f("lyrics-update",A)}},j=C=>{C.forEach(($,_)=>{$.lineNumber=_+1})},H=C=>{const $=Math.floor(C/1e3),_=Math.floor($/60),A=$%60;return"".concat(_,":").concat(A.toString().padStart(2,"0"))},X=C=>{s.isTimingMode&&(C.code==="Space"?C.preventDefault():C.code==="ArrowUp"?(C.preventDefault(),s.currentLine>0&&f("line-select",s.currentLine-1)):C.code==="ArrowDown"&&(C.preventDefault(),s.currentLine<s.lyrics.length-1&&f("line-select",s.currentLine+1)))};return typeof window<"u"&&window.addEventListener("keydown",X),(C,$)=>(c(),v("div",Et,[e("div",Ft,[e("div",Wt,[$[1]||($[1]=e("h5",{class:"mb-0"},"📝 Lyrics Editor",-1)),e("div",It,[e("button",{class:"btn btn-sm btn-outline-primary me-2",onClick:T,title:"Add new line"},[...$[0]||($[0]=[e("i",{class:"bi bi-plus"},null,-1)])]),e("span",{class:G(["badge",n.isTimingMode?"bg-success":"bg-secondary"])},b(n.isTimingMode?"Timing Mode":"Editing Ready"),3)])]),e("div",Rt,[e("div",{class:"lyrics-container",ref_key:"lyricsContainer",ref:h},[(c(!0),v(ne,null,de(n.lyrics,(_,A)=>(c(),v("div",{key:_.id,class:G(["lyric-line",{active:A===n.currentLine,"has-timing":_.startTime!==void 0,"timing-mode":n.isTimingMode,"metadata-line":d(_)}]),onClick:Q=>M(A)},[e("div",Nt,b(_.lineNumber),1),e("div",jt,[_.startTime!==void 0?(c(),v("small",zt,b(H(_.startTime)),1)):d(_)?(c(),v("small",Ut," META ")):(c(),v("small",qt,"--:--"))]),e("div",Vt,[t.value===A&&!d(_)?Ze((c(),v("input",{key:0,type:"text",class:"form-control form-control-sm","onUpdate:modelValue":Q=>_.text=Q,onBlur:F,onKeyup:[He(F,["enter"]),He(W,["esc"])],ref_for:!0,ref_key:"editInput",ref:l,placeholder:"Use / to separate syllables: Hel/lo world a/maz/ing"},null,40,Ht)),[[tt,_.text]]):t.value===A&&d(_)?Ze((c(),v("input",{key:1,type:"text",class:"form-control form-control-sm","onUpdate:modelValue":Q=>_.text=Q,onBlur:F,onKeyup:[He(F,["enter"]),He(W,["esc"])],ref_for:!0,ref_key:"editInput",ref:l,placeholder:"[@TITLE:], [@AUTHOR:], or [@CAPTION:]"},null,40,Kt)),[[tt,_.text]]):(c(),v("div",{key:2,class:G(["lyric-text",{empty:!_.text.trim(),"metadata-text":d(_)}]),onDblclick:Q=>p(A)},[d(_)?(c(),v("div",Gt,[$[2]||($[2]=e("i",{class:"bi bi-tag me-1"},null,-1)),V(b(_.text),1)])):_.words.length>0?(c(),v("div",Xt,[(c(!0),v(ne,null,de(_.words,(Q,ue)=>(c(),v("span",{key:ue,class:G(["word-item",{"current-word":A===n.currentLine&&ue===n.currentWord,"timed-word":Q.startTime!==void 0}])},[(c(!0),v(ne,null,de(Q.syllables,(we,ke)=>(c(),v("span",{key:ke,class:G(["syllable-item",{"timed-syllable":we.startTime!==void 0}])},b(we.syllable),3))),128))],2))),128))])):(c(),v("div",Jt,"Empty line - double click to edit"))],42,Ot))]),e("div",Qt,[n.isTimingMode?q("",!0):(c(),v("button",{key:0,class:"btn btn-sm btn-outline-danger",onClick:Q=>x(A),title:"Delete line"},[...$[3]||($[3]=[e("i",{class:"bi bi-trash3"},null,-1)])],8,Zt)),n.isTimingMode&&_.startTime!==void 0&&!d(_)?(c(),v("button",{key:1,class:"btn btn-sm btn-outline-warning",onClick:Q=>U(A),title:"Clear timing"},[...$[4]||($[4]=[e("i",{class:"bi bi-clock-history"},null,-1)])],8,Yt)):q("",!0)])],10,Bt))),128)),n.lyrics.length===0?(c(),v("div",ei,[...$[5]||($[5]=[e("p",{class:"text-muted"},'No lyrics yet. Click "+" to add your first line.',-1)])])):q("",!0)],512)]),e("div",ti,[e("div",ii,[e("div",si,[e("small",ai,b(n.lyrics.length)+" lines • "+b(u.value)+"/"+b(n.lyrics.length)+" timed ",1)]),e("div",ni,[n.isTimingMode?(c(),v("small",oi,[...$[6]||($[6]=[V(" Press ",-1),e("kbd",null,"Space",-1),V(" to assign timing to current line ",-1)])])):(c(),v("small",li," Double-click to edit lyrics "))])])])])]))}});const di=Ue(ri,[["__scopeId","data-v-a03a354a"]]),ui={class:"lyrics-preview"},ci={class:"card"},mi={class:"card-header d-flex justify-content-between align-items-center"},vi={class:"preview-controls"},fi={class:"btn-group",role:"group"},gi={key:0,class:"empty-state text-center py-4"},yi={key:0,class:"karaoke-display"},bi={class:"karaoke-position position-1"},hi={key:0,class:"display-title"},pi={key:1,class:"display-caption"},wi={class:"karaoke-position position-2"},ki={key:0,class:"display-author"},Ti={key:1,class:"display-caption"},xi={class:"karaoke-position position-3"},$i={key:0,class:"display-caption"},Si={class:"line-text"},Mi={class:"future-lines"},Ci={key:1,class:"normal-display"},Li={class:"line-content"},_i={class:"line-number"},Ai={class:"line-text"},Pi={key:0,class:"line-timing"},Di={key:0,class:"line-progress"},Ei={class:"card-footer"},Fi={class:"row align-items-center"},Wi={class:"col-sm-6"},Ii={class:"text-muted"},Ri={key:0},Bi={class:"col-sm-6 text-end"},Ni={class:"text-muted"},ji={key:0},zi=Pe({__name:"LyricsPreview",props:{lyrics:{},currentTime:{},currentLine:{},currentWord:{},currentSyllable:{}},setup(n){const o=n,s=E(!0),f=E("medium"),t=E(),h=O(()=>o.lyrics[o.currentLine]||null),l=O(()=>{if(!h.value||h.value.startTime===void 0)return!1;const k=h.value.startTime,P=h.value.endTime||k+(h.value.duration||3e3);return o.currentTime>=k&&o.currentTime<=P}),u=O(()=>o.lyrics.filter(k=>k.startTime!==void 0).length),d=O(()=>o.lyrics.length===0?0:Math.round(u.value/o.lyrics.length*100)),M=O(()=>{const k=o.lyrics.map(S=>S.text).join("\n"),{metadata:P}=kt(k);return P}),T=O(()=>M.value.title||null),x=O(()=>M.value.author||null),p=O(()=>{var S;const k=o.lyrics.filter(Z=>Z.type==="caption");if(k.length===0)return null;let P=null;for(let Z=0;Z<k.length;Z++){const Y=k[Z];if(o.lyrics.findIndex(We=>We.id===Y.id)<=o.currentLine)P=((S=Y.metadata)==null?void 0:S.caption)||Y.text.replace(/^\[@CAPTION:\s*/,"").replace(/\]$/,"");else break}return P}),F=O(()=>T.value?{type:"title",text:T.value}:p.value?{type:"caption",text:p.value}:{type:"empty",text:""}),W=O(()=>x.value?{type:"author",text:x.value}:p.value&&F.value.type==="title"?{type:"caption",text:p.value}:{type:"empty",text:""}),U=O(()=>p.value&&F.value.type==="title"&&W.value.type==="author"?{type:"caption",text:p.value}:{type:"empty",text:""}),j=O(()=>o.lyrics.slice(o.currentLine+1).filter(S=>!S.type||S.type==="lyrics").slice(0,1)),H=()=>{s.value=!s.value},X=k=>{f.value=k},C=k=>{if(k.startTime===void 0)return!1;const P=k.startTime,S=k.endTime||P+(k.duration||3e3);return o.currentTime>=P&&o.currentTime<=S},$=k=>{if(!k.startTime||!k.duration)return 0;const S=(o.currentTime-k.startTime)/k.duration*100;return Math.max(0,Math.min(100,S))},_=k=>{const P=Math.floor(k/1e3),S=Math.floor(P/60),Z=P%60;return"".concat(S,":").concat(Z.toString().padStart(2,"0"))},A=k=>k.type&&k.type!=="lyrics"?k.text:k.words&&k.words.length>0?k.words.map(P=>P.word).join(" "):k.text||"",Q=(k,P)=>{const S=k.words[P];return S!=null&&S.endTime?o.currentTime>S.endTime:!1},ue=(k,P)=>{const S=k.words[P];return S!=null&&S.startTime?o.currentTime<S.startTime:!1},we=k=>k!=null&&k.endTime?o.currentTime>k.endTime:!1,ke=k=>k!=null&&k.startTime?o.currentTime<k.startTime:!1;return je(()=>o.currentLine,()=>{s.value||Se(()=>{const k=t.value;if(k){const P=k.querySelector(".preview-line.current");P&&P.scrollIntoView({behavior:"smooth",block:"center"})}})}),(k,P)=>(c(),v("div",ui,[e("div",ci,[e("div",mi,[P[4]||(P[4]=e("h5",{class:"mb-0"},"👁️ Lyrics Preview",-1)),e("div",vi,[e("button",{class:G(["btn btn-sm btn-outline-secondary me-2",{active:s.value}]),onClick:H,title:"Toggle karaoke mode"},[...P[3]||(P[3]=[e("i",{class:"bi bi-display"},null,-1)])],2),e("div",fi,[e("button",{class:G(["btn btn-sm btn-outline-primary",{active:f.value==="small"}]),onClick:P[0]||(P[0]=S=>X("small"))}," A ",2),e("button",{class:G(["btn btn-sm btn-outline-primary",{active:f.value==="medium"}]),onClick:P[1]||(P[1]=S=>X("medium"))}," A ",2),e("button",{class:G(["btn btn-sm btn-outline-primary",{active:f.value==="large"}]),onClick:P[2]||(P[2]=S=>X("large"))}," A ",2)])])]),e("div",{class:G(["card-body preview-container",["font-".concat(f.value),{"karaoke-mode":s.value}]])},[n.lyrics.length===0?(c(),v("div",gi,[...P[5]||(P[5]=[e("p",{class:"text-muted"},"No lyrics to preview",-1)])])):(c(),v("div",{key:1,class:"lyrics-display",ref_key:"lyricsDisplay",ref:t},[s.value?(c(),v("div",yi,[e("div",bi,[F.value.type==="title"?(c(),v("div",hi,b(F.value.text),1)):F.value.type==="caption"?(c(),v("div",pi,b(F.value.text),1)):q("",!0)]),e("div",wi,[W.value.type==="author"?(c(),v("div",ki,b(W.value.text),1)):W.value.type==="caption"?(c(),v("div",Ti,b(W.value.text),1)):q("",!0)]),e("div",xi,[U.value.type==="caption"?(c(),v("div",$i,b(U.value.text),1)):q("",!0)]),h.value&&(!h.value.type||h.value.type==="lyrics")?(c(),v("div",{key:0,class:G(["current-line-display",{highlighted:l.value}])},[e("div",Si,[(c(!0),v(ne,null,de(h.value.words,(S,Z)=>(c(),v("span",{key:Z,class:G(["karaoke-word",{"current-word":Z===n.currentWord,"past-word":Q(h.value,Z),"future-word":ue(h.value,Z)}])},[(c(!0),v(ne,null,de(S.syllables,(Y,ce)=>(c(),v("span",{key:ce,class:G(["karaoke-syllable",{"current-syllable":Z===n.currentWord&&ce===n.currentSyllable,"past-syllable":we(Y),"future-syllable":ke(Y)}])},b(Y.syllable),3))),128)),P[6]||(P[6]=V(" "+b(" "),-1))],2))),128))])],2)):q("",!0),e("div",Mi,[(c(!0),v(ne,null,de(j.value,S=>(c(),v("div",{key:"future-".concat(S.id),class:"future-line"},b(A(S)),1))),128))])])):(c(),v("div",Ci,[(c(!0),v(ne,null,de(n.lyrics,(S,Z)=>(c(),v("div",{key:S.id,class:G(["preview-line",{current:Z===n.currentLine,"has-timing":S.startTime!==void 0,past:S.startTime!==void 0&&S.startTime<n.currentTime,future:S.startTime!==void 0&&S.startTime>n.currentTime,playing:C(S)}])},[e("div",Li,[e("span",_i,b(S.lineNumber),1),e("span",Ai,b(A(S)),1),S.startTime!==void 0?(c(),v("span",Pi,b(_(S.startTime)),1)):q("",!0)]),C(S)&&S.duration?(c(),v("div",Di,[e("div",{class:"progress-bar",style:ze({width:$(S)+"%"})},null,4)])):q("",!0)],2))),128))]))],512))],2),e("div",Ei,[e("div",Fi,[e("div",Wi,[e("small",Ii,[V(" Line "+b(n.currentLine+1)+" of "+b(n.lyrics.length)+" ",1),n.currentTime>0?(c(),v("span",Ri," • "+b(_(n.currentTime)),1)):q("",!0)])]),e("div",Bi,[e("small",Ni,[V(b(u.value)+"/"+b(n.lyrics.length)+" lines timed ",1),d.value>0?(c(),v("span",ji,"("+b(d.value)+"%)",1)):q("",!0)])])])])])]))}});const Ui=Ue(zi,[["__scopeId","data-v-3e106210"]]),qi={class:"waveform-viewer"},Vi={class:"card"},Hi={class:"card-header"},Ki={class:"d-flex justify-content-between align-items-center mb-2"},Oi={class:"d-flex align-items-center"},Gi={key:0,class:"mode-indicator me-3"},Xi={key:1,class:"loading-spinner me-2"},Ji={class:"controls-row d-flex justify-content-between align-items-center flex-wrap gap-2"},Qi={class:"player-controls d-flex align-items-center gap-2"},Zi=["disabled"],Yi={class:"view-controls d-flex align-items-center gap-2"},es={class:"btn-group",role:"group"},ts={key:0,class:"zoom-controls d-flex align-items-center"},is=["disabled"],ss={class:"zoom-level mx-2"},as=["disabled"],ns={key:1,class:"window-controls d-flex align-items-center gap-2"},os={key:0,class:"progress-container mt-2"},ls={class:"time-display d-flex justify-content-between mt-1"},rs={class:"text-muted"},ds={class:"text-muted"},us={class:"card-body p-0"},cs={key:0,class:"loading-state d-flex align-items-center justify-content-center"},ms={key:1,class:"no-audio-state d-flex align-items-center justify-content-center"},vs={key:2},fs=["width","height"],gs=["onClick","onMousedown","title"],ys={class:"marker-label"},bs={class:"time-scale"},hs={class:"time-mark-label"},ps={class:"card-footer"},ws={class:"row align-items-center"},ks={class:"col-sm-4"},Ts={class:"text-muted"},xs={key:0},$s={key:1},Ss={class:"col-sm-4 text-center"},Ms={class:"text-muted"},Cs={class:"col-sm-4 text-end"},Ls={class:"text-muted"},_s={key:0},As={key:1},Ps=Pe({__name:"WaveformViewer",props:{audioFile:{},lyrics:{},currentTime:{},waveformData:{},currentLineIndex:{default:0},playbackState:{},isTimingMode:{type:Boolean,default:!1}},emits:["seek","lyrics-position","selection","play-pause","skip-backward","skip-forward","view-window-change"],setup(n,{emit:o}){const s=n,f=o,t=E(),h=E(),l=E(!1),u=E(null),d=E(1),M=E(800),T=E(120),x=E(null),p=E(null),F=E(!1),W=E(-1),U=E([]),j=E("window"),H=E(15e3),X=E(0),C=E(!0),$=O(()=>s.lyrics.filter(g=>g.startTime!==void 0).map(g=>({...g,position:ke(g.startTime)}))),_=O(()=>s.lyrics.filter(g=>g.startTime!==void 0).length),A=O(()=>{var g;return!s.playbackState||!((g=s.audioFile)!=null&&g.duration)?0:Math.min(s.currentTime/s.audioFile.duration*100,100)}),Q=O(()=>{if(x.value!==null&&p.value!==null){const g=k(Math.min(x.value,p.value));return k(Math.max(x.value,p.value))-g}return 0}),ue=O(()=>{if(x.value!==null&&p.value!==null){const g=Math.min(x.value,p.value),m=Math.abs(p.value-x.value);return{left:g+"px",width:m+"px"}}return{}}),we=O(()=>{var m;if(!((m=s.audioFile)!=null&&m.duration))return[];const g=[];if(j.value==="window"){const w=Math.floor(X.value),R=H.value,B=w+R,K=R>3e4?5e3:2e3,D=Math.ceil(w/K)*K;for(let ee=D;ee<=B;ee+=K)if(ee>=w){const ae=(ee-w)/R;ae>=0&&ae<=1&&g.push({time:ee,position:ae*M.value,label:ge(ee)})}}else{const w=s.audioFile.duration,R=w>6e4?1e4:5e3;for(let B=0;B<=w;B+=R)g.push({time:B,position:ke(B),label:ge(B)})}return g}),ke=g=>{var w;return(w=s.audioFile)!=null&&w.duration?g/s.audioFile.duration*M.value*d.value:0},k=g=>{var w;return(w=s.audioFile)!=null&&w.duration?g/(M.value*d.value)*s.audioFile.duration:0},P=g=>{if(F.value)return;const m=h.value.getBoundingClientRect(),w=g.clientX-m.left,R=k(w);f("seek",R)},S=(g,m)=>{if(m.stopPropagation(),m.ctrlKey||m.metaKey){const w=U.value.indexOf(g);w>=0?U.value.splice(w,1):U.value.push(g)}else U.value=[g]},Z=(g,m)=>{m.stopPropagation(),F.value=!0,W.value=g;const w=()=>{F.value},R=()=>{if(F.value){const B=h.value.getBoundingClientRect(),K=m.clientX-B.left,D=k(K);f("lyrics-position",W.value,Math.max(0,D))}F.value=!1,W.value=-1,document.removeEventListener("mousemove",w),document.removeEventListener("mouseup",R)};document.addEventListener("mousemove",w),document.addEventListener("mouseup",R)},Y=g=>{if(g.target!==h.value)return;const m=h.value.getBoundingClientRect(),w=g.clientX-m.left;x.value=w,p.value=w},ce=g=>{if(x.value===null)return;const m=h.value.getBoundingClientRect(),w=g.clientX-m.left;p.value=w},We=()=>{if(x.value!==null&&p.value!==null){const g=k(Math.min(x.value,p.value)),m=k(Math.max(x.value,p.value));Math.abs(p.value-x.value)>5&&f("selection",g,m)}setTimeout(()=>{x.value=null,p.value=null},2e3)},Ke=()=>{d.value<5&&(d.value+=.5,me())},Oe=()=>{d.value>1&&(d.value-=.5,me())},qe=g=>{j.value=g,g==="window"&&(d.value=1,Ce()),me(),fe()},Me=()=>{Ce(),me(),fe()},Ge=()=>{C.value=!C.value},fe=()=>{var g;if(j.value==="window"){const m=X.value/1e3,w=(X.value+H.value)/1e3;f("view-window-change",m,w,"window")}else{const m=((g=s.audioFile)==null?void 0:g.duration)||6e4;f("view-window-change",0,m/1e3,"full")}},Ce=()=>{if(j.value==="window"){const g=H.value/2;C.value&&s.currentTime>0?s.currentTime<=g?X.value=0:X.value=Math.max(0,s.currentTime-g):X.value=0}fe()},Xe=g=>{var D;if(!((D=s.audioFile)!=null&&D.duration))return;const w=g.currentTarget.getBoundingClientRect(),K=(g.clientX-w.left)/w.width*s.audioFile.duration;f("seek",K)},me=async()=>{var Le,Ee;const g=h.value,m=s.waveformData||u.value;if(!g||!m)return;const w=g.getContext("2d");if(!w)return;w.clearRect(0,0,g.width,g.height);const{peaks:R}=m,B=g.width,K=g.height;let D=R,ee=0;if(j.value==="window"){const te=m.duration||((Le=s.audioFile)==null?void 0:Le.duration)||1,ie=X.value/te,ye=H.value/te;ee=Math.floor(ie*R.length);const be=Math.min(Math.floor((ie+ye)*R.length),R.length);if(D=R.slice(ee,be),D.length===0){const _e=Math.min(Math.floor(R.length*.2),R.length);D=R.slice(0,_e)}}const ae=B/D.length;w.fillStyle="#3b82f6",w.strokeStyle="#1d4ed8";const oe=j.value==="window"?Math.max(1,Math.ceil(D.length/(B*2))):Math.max(1,Math.ceil(D.length/(B*d.value*2)));for(let te=0;te<D.length;te+=oe){const ie=Math.abs(D[te]),ye=3,be=Math.min(ie*K*ye,K*.95),_e=j.value==="window"?te/D.length*B:te/D.length*B*d.value,Ie=K-be,a=j.value==="window"?Math.max(1,B/D.length*oe):Math.max(1,ae*d.value);be>1&&w.fillRect(_e,Ie,a,be)}if(w.strokeStyle="#6b7280",w.lineWidth=1,w.beginPath(),w.moveTo(0,K-1),w.lineTo(B,K-1),w.stroke(),s.currentTime!==void 0){const te=m.duration||((Ee=s.audioFile)==null?void 0:Ee.duration);if(te){let ie;if(j.value==="window"){const ye=H.value/2,be=te-ye;if(s.currentTime<=ye)ie=s.currentTime/H.value*B;else if(s.currentTime>=be){const _e=te-s.currentTime,Ie=H.value;ie=B-_e/Ie*B}else ie=B/2}else ie=s.currentTime/te*B*d.value;ie>=0&&ie<=B&&(w.strokeStyle="#ef4444",w.lineWidth=3,w.beginPath(),w.moveTo(ie,0),w.lineTo(ie,K),w.stroke())}}},Je=async()=>{var g;if((g=s.audioFile)!=null&&g.file){l.value=!0;try{const m=new AudioContext,w=await s.audioFile.file.arrayBuffer(),R=await m.decodeAudioData(w),B=R.getChannelData(0),K=8e3,D=Math.floor(B.length/K),ee=[];let ae=0;for(let oe=0;oe<B.length;oe++)ae=Math.max(ae,Math.abs(B[oe]));for(let oe=0;oe<K;oe++){const Le=oe*D,Ee=Le+D;let te=0;for(let ie=Le;ie<Ee;ie++)te=Math.max(te,Math.abs(B[ie]));ee.push(ae>0?te/ae:0)}u.value={peaks:ee,sampleRate:R.sampleRate,duration:R.duration,channels:R.numberOfChannels},j.value==="window"&&Ce(),Se(()=>{me()})}catch(m){console.error("Error generating waveform:",m)}finally{l.value=!1}}},ge=g=>{const m=Math.floor(g/1e3),w=Math.floor(m/60),R=m%60;return"".concat(w,":").concat(R.toString().padStart(2,"0"))},De=()=>{t.value&&(M.value=t.value.clientWidth-20)};return je(()=>s.audioFile,()=>{var g;(g=s.audioFile)!=null&&g.file&&Je()},{immediate:!0}),je(()=>s.waveformData,()=>{s.waveformData&&Se(()=>{me()})}),je(()=>u.value,()=>{u.value&&Se(()=>{me()})}),je(()=>s.currentTime,(g,m)=>{var w;if(j.value==="window"&&g!==void 0&&((w=s.audioFile)!=null&&w.duration)){const R=H.value/2,B=m!==void 0&&Math.abs(g-m)>2e3;if(C.value||B){const K=s.audioFile.duration-R;g<=R?X.value=0:g>=K?X.value=Math.max(0,s.audioFile.duration-H.value):X.value=Math.max(0,Math.min(g-R,s.audioFile.duration-H.value)),fe()}}Se(()=>{me()})}),ot(()=>{De(),window.addEventListener("resize",De),fe()}),(g,m)=>{var w,R,B,K;return c(),v("div",qi,[e("div",Vi,[e("div",Hi,[e("div",Ki,[m[7]||(m[7]=e("h5",{class:"mb-0"},"🌊 Audio Waveform & Controls",-1)),e("div",Oi,[n.isTimingMode!==void 0?(c(),v("div",Gi,[e("span",{class:G(["badge",n.isTimingMode?"bg-warning":"bg-secondary"])},b(n.isTimingMode?"Timing Mode":"Playback Mode"),3)])):q("",!0),l.value?(c(),v("div",Xi,[...m[6]||(m[6]=[e("div",{class:"spinner-border spinner-border-sm",role:"status"},[e("span",{class:"visually-hidden"},"Loading...")],-1)])])):q("",!0)])]),e("div",Ji,[e("div",Qi,[e("button",{class:"btn btn-outline-secondary btn-sm",onClick:m[0]||(m[0]=D=>f("skip-backward")),title:"Skip backward 10s"},[...m[8]||(m[8]=[e("i",{class:"bi bi-skip-backward"},null,-1)])]),e("button",{class:"btn btn-primary btn-sm",onClick:m[1]||(m[1]=D=>f("play-pause")),disabled:!((w=n.audioFile)!=null&&w.file)},[e("i",{class:G(n.playbackState.isPlaying?"bi bi-pause-fill":"bi bi-play-fill")},null,2)],8,Zi),e("button",{class:"btn btn-outline-secondary btn-sm",onClick:m[2]||(m[2]=D=>f("skip-forward")),title:"Skip forward 10s"},[...m[9]||(m[9]=[e("i",{class:"bi bi-skip-forward"},null,-1)])])]),e("div",Yi,[e("div",es,[e("button",{class:G(["btn btn-sm",j.value==="window"?"btn-primary":"btn-outline-primary"]),onClick:m[3]||(m[3]=D=>qe("window")),title:"Sliding window view"},[...m[10]||(m[10]=[e("i",{class:"bi bi-window"},null,-1),V(" Window ",-1)])],2),e("button",{class:G(["btn btn-sm",j.value==="full"?"btn-primary":"btn-outline-primary"]),onClick:m[4]||(m[4]=D=>qe("full")),title:"Full song view"},[...m[11]||(m[11]=[e("i",{class:"bi bi-arrows-fullscreen"},null,-1),V(" Full ",-1)])],2)]),j.value==="full"?(c(),v("div",ts,[e("button",{class:"btn btn-sm btn-outline-secondary",onClick:Oe,disabled:d.value<=1,title:"Zoom out"},[...m[12]||(m[12]=[e("i",{class:"bi bi-zoom-out"},null,-1)])],8,is),e("span",ss,b(Math.round(d.value*100))+"%",1),e("button",{class:"btn btn-sm btn-outline-secondary",onClick:Ke,disabled:d.value>=5,title:"Zoom in"},[...m[13]||(m[13]=[e("i",{class:"bi bi-zoom-in"},null,-1)])],8,as)])):q("",!0),j.value==="window"?(c(),v("div",ns,[Ze(e("select",{class:"form-select form-select-sm","onUpdate:modelValue":m[5]||(m[5]=D=>H.value=D),onChange:Me},[...m[14]||(m[14]=[e("option",{value:5e3},"5s",-1),e("option",{value:1e4},"10s",-1),e("option",{value:15e3},"15s",-1),e("option",{value:25e3},"25s",-1)])],544),[[vt,H.value]]),e("button",{class:G(["btn btn-sm",C.value?"btn-success":"btn-outline-success"]),onClick:Ge,title:"Auto-scroll with playback"},[...m[15]||(m[15]=[e("i",{class:"bi bi-skip-end"},null,-1)])],2)])):q("",!0)])]),n.playbackState?(c(),v("div",os,[e("div",{class:"progress",style:{height:"6px",cursor:"pointer"},onClick:Xe},[e("div",{class:"progress-bar",style:ze({width:A.value+"%"}),role:"progressbar"},null,4)]),e("div",ls,[e("small",rs,b(ge(n.currentTime)),1),e("small",ds,b(ge(((R=n.audioFile)==null?void 0:R.duration)||0)),1)])])):q("",!0)]),e("div",us,[e("div",{class:"waveform-container",ref_key:"waveformContainer",ref:t},[l.value?(c(),v("div",cs,[...m[16]||(m[16]=[e("div",{class:"spinner-border text-primary me-2",role:"status"},null,-1),e("span",null,"Analyzing audio...",-1)])])):(B=n.audioFile)!=null&&B.file?(c(),v("div",vs,[ft(g.$slots,"above-waveform",{},void 0,!0),e("div",{class:"waveform-canvas-container",onMousedown:Y,onMousemove:ce,onMouseup:We},[e("canvas",{ref_key:"waveformCanvas",ref:h,class:"waveform-canvas",width:M.value,height:T.value,onClick:P},null,8,fs),(c(!0),v(ne,null,de($.value,(D,ee)=>(c(),v("div",{key:D.id,class:G(["lyric-marker",{active:ee===n.currentLineIndex,selected:U.value.includes(ee)}]),style:ze({left:D.position+"px"}),onClick:ae=>S(ee,ae),onMousedown:ae=>Z(ee,ae),title:"Line ".concat(D.lineNumber,": ").concat(D.text)},[m[18]||(m[18]=e("div",{class:"marker-line"},null,-1)),e("div",ys,b(D.lineNumber),1)],46,gs))),128)),x.value!==null&&p.value!==null?(c(),v("div",{key:0,class:"selection-area",style:ze(ue.value)},null,4)):q("",!0),e("div",bs,[(c(!0),v(ne,null,de(we.value,D=>(c(),v("div",{key:D.time,class:"time-mark",style:ze({left:D.position+"px"})},[m[19]||(m[19]=e("div",{class:"time-mark-line"},null,-1)),e("div",hs,b(D.label),1)],4))),128))])],32)])):(c(),v("div",ms,[...m[17]||(m[17]=[e("div",{class:"text-center text-muted"},[e("i",{class:"bi bi-music-note-beamed display-4"}),e("p",{class:"mt-2"},"No audio file loaded")],-1)])]))],512)]),e("div",ps,[e("div",ws,[e("div",ks,[e("small",Ts,[(K=n.audioFile)!=null&&K.duration?(c(),v("span",xs,"Duration: "+b(ge(n.audioFile.duration)),1)):q("",!0),Q.value?(c(),v("span",$s," • Selection: "+b(ge(Q.value)),1)):q("",!0)])]),e("div",Ss,[e("small",Ms,b(n.lyrics.length)+" lyrics • "+b(_.value)+" positioned ",1)]),e("div",Cs,[e("small",Ls,[j.value==="window"?(c(),v("span",_s,"Window: "+b(ge(H.value)),1)):q("",!0),j.value==="full"?(c(),v("span",As,"Zoom: "+b(Math.round(d.value*100))+"%",1)):q("",!0)])])])])])])}}});const Ds=Ue(Ps,[["__scopeId","data-v-d3d7a42c"]]),Es={class:"mb-4"},Fs={class:"d-grid gap-1"},Ws={class:"timing-status small text-muted mt-1"},Is={class:"mb-4"},Rs={class:"d-grid gap-1"},Bs=["disabled"],Ns=["disabled"],js=["disabled"],zs=["disabled"],Us={key:0,class:"mt-2 p-2 bg-light rounded small"},qs={class:"row"},Vs={class:"col-6"},Hs={class:"col-6"},Ks={class:"mb-4"},Os={class:"d-grid gap-1"},Gs=["disabled"],Xs=["disabled"],Js=["disabled"],Qs={class:"mb-2"},Zs={key:0,class:"mb-2"},Ys={class:"mb-0 ps-3"},ea={key:0,class:"small text-muted"},ta={key:1,class:"mb-2"},ia={class:"mb-0 ps-3"},sa={key:0,class:"small text-muted"},aa={key:2,class:"mb-2"},na={class:"small"},oa={class:"small text-muted"},la=Pe({__name:"TimingControlsPanel",props:{isTimingMode:{type:Boolean},timedWords:{},totalWords:{},songAnalysis:{},timingAnalysis:{}},emits:["toggle-timing-mode","apply-musical-timing","reset-syllable-timing","clear-timing","analyze-timing","fix-overlaps"],setup(n){const o=n,s=E(!1),f=E(!1),t=O(()=>(o.timedWords||0)>0);return(h,l)=>(c(),v(ne,null,[e("div",Es,[l[9]||(l[9]=e("h6",null,[e("i",{class:"bi bi-stopwatch"}),V(" Timing Mode")],-1)),e("div",Fs,[e("button",{class:G(["btn btn-sm",n.isTimingMode?"btn-warning":"btn-outline-primary"]),onClick:l[0]||(l[0]=u=>h.$emit("toggle-timing-mode"))},[l[8]||(l[8]=e("i",{class:"bi bi-crosshair"},null,-1)),V(" "+b(n.isTimingMode?"Exit Timing":"Start Timing"),1)],2),e("div",Ws,[n.isTimingMode?(c(),v(ne,{key:0},[V(" Press Space during playback to assign word timings ")],64)):(c(),v(ne,{key:1},[V(" Word boxes can be edited manually ")],64))])])]),e("div",Is,[l[20]||(l[20]=e("h6",null,[e("i",{class:"bi bi-music-note"}),V(" Musical Timing")],-1)),e("div",Rs,[e("button",{class:"btn btn-sm btn-outline-success",onClick:l[1]||(l[1]=u=>h.$emit("apply-musical-timing")),disabled:!t.value},[...l[10]||(l[10]=[e("i",{class:"bi bi-magic"},null,-1),V(" Apply Musical Intelligence ",-1)])],8,Bs),e("button",{class:"btn btn-sm btn-outline-secondary",onClick:l[2]||(l[2]=u=>h.$emit("reset-syllable-timing")),disabled:!t.value},[...l[11]||(l[11]=[e("i",{class:"bi bi-arrow-clockwise"},null,-1),V(" Reset Syllable Timing ",-1)])],8,Ns),e("button",{class:"btn btn-sm btn-outline-danger",onClick:l[3]||(l[3]=u=>h.$emit("clear-timing")),disabled:!t.value},[...l[12]||(l[12]=[e("i",{class:"bi bi-trash"},null,-1),V(" Clear from Current Line ",-1)])],8,js),e("button",{class:"btn btn-sm btn-outline-info",onClick:l[4]||(l[4]=u=>s.value=!s.value),disabled:!t.value},[l[13]||(l[13]=e("i",{class:"bi bi-graph-up"},null,-1)),V(" "+b(s.value?"Hide":"Show")+" Analysis ",1)],8,zs)]),s.value&&n.songAnalysis?(c(),v("div",Us,[e("div",qs,[e("div",Vs,[l[14]||(l[14]=e("strong",null,"BPM:",-1)),V(" "+b(n.songAnalysis.estimatedBPM.toFixed(0)),1),l[15]||(l[15]=e("br",null,null,-1)),l[16]||(l[16]=e("strong",null,"Words:",-1)),V(" "+b(n.songAnalysis.totalWords),1)]),e("div",Hs,[l[17]||(l[17]=e("strong",null,"Rests:",-1)),V(" "+b(n.songAnalysis.detectedRests),1),l[18]||(l[18]=e("br",null,null,-1)),l[19]||(l[19]=e("strong",null,"Quality:",-1)),V(" "+b(n.songAnalysis.timingQuality),1)])])])):q("",!0),l[21]||(l[21]=e("div",{class:"timing-status small text-muted mt-1"}," Musical timing analyzes your word timings to distribute syllables using musical patterns (8th notes, quarter notes, etc.) and respects natural pauses. ",-1))]),e("div",Ks,[l[29]||(l[29]=e("h6",null,[e("i",{class:"bi bi-search"}),V(" Timing Diagnostics")],-1)),e("div",Os,[e("button",{class:"btn btn-sm btn-outline-info",onClick:l[5]||(l[5]=u=>h.$emit("analyze-timing")),disabled:!t.value},[...l[22]||(l[22]=[e("i",{class:"bi bi-bug"},null,-1),V(" Check for Overlaps ",-1)])],8,Gs),e("button",{class:"btn btn-sm btn-outline-warning",onClick:l[6]||(l[6]=u=>h.$emit("fix-overlaps")),disabled:!t.value},[...l[23]||(l[23]=[e("i",{class:"bi bi-wrench"},null,-1),V(" Fix Overlaps ",-1)])],8,Xs),e("button",{class:"btn btn-sm btn-outline-secondary",onClick:l[7]||(l[7]=u=>f.value=!f.value),disabled:!t.value},[l[24]||(l[24]=e("i",{class:"bi bi-info-circle"},null,-1)),V(" "+b(f.value?"Hide":"Show")+" Details ",1)],8,Js)]),f.value&&n.timingAnalysis?(c(),v("div",{key:0,class:G(["mt-2 p-2 rounded small",n.timingAnalysis.hasIssues?"bg-warning bg-opacity-10 border border-warning":"bg-success bg-opacity-10 border border-success"])},[e("div",Qs,[l[25]||(l[25]=e("strong",null,"Status:",-1)),V(" "+b(n.timingAnalysis.summary),1)]),n.timingAnalysis.sequenceViolations&&n.timingAnalysis.sequenceViolations.length>0?(c(),v("div",Zs,[l[26]||(l[26]=e("strong",{class:"text-danger"},"🚨 Sequence Violations:",-1)),e("ul",Ys,[(c(!0),v(ne,null,de(n.timingAnalysis.sequenceViolations.slice(0,3),u=>(c(),v("li",{key:"".concat(u.word1,"-").concat(u.word2),class:"small text-danger"},b(u.issue),1))),128)),n.timingAnalysis.sequenceViolations.length>3?(c(),v("li",ea," ...and "+b(n.timingAnalysis.sequenceViolations.length-3)+" more ",1)):q("",!0)])])):q("",!0),n.timingAnalysis.overlaps.length>0?(c(),v("div",ta,[l[27]||(l[27]=e("strong",{class:"text-warning"},"Overlaps Found:",-1)),e("ul",ia,[(c(!0),v(ne,null,de(n.timingAnalysis.overlaps.slice(0,5),u=>(c(),v("li",{key:"".concat(u.word1.lineIndex,"-").concat(u.word1.wordIndex),class:"small"},' "'+b(u.word1.word)+'" → "'+b(u.word2.word)+'" ('+b(u.overlapDuration)+"ms overlap) ",1))),128)),n.timingAnalysis.overlaps.length>5?(c(),v("li",sa," ...and "+b(n.timingAnalysis.overlaps.length-5)+" more ",1)):q("",!0)])])):q("",!0),n.timingAnalysis.smallGaps.length>0?(c(),v("div",aa,[l[28]||(l[28]=e("strong",{class:"text-info"},"Small Gaps:",-1)),e("span",na,b(n.timingAnalysis.smallGaps.length)+" gaps < 50ms",1)])):q("",!0),e("div",oa,b(n.timingAnalysis.timedWords)+" of "+b(n.timingAnalysis.totalWords)+" words have timing data ",1)],2)):q("",!0),l[30]||(l[30]=e("div",{class:"timing-status small text-muted mt-1"}," Overlapping word timings can cause editing issues. Use diagnostics to detect and fix timing problems. ",-1))])],64))}}),ra={class:"mb-4"},da={class:"small"},ua={class:"d-flex justify-content-between"},ca={class:"d-flex justify-content-between"},ma={class:"d-flex justify-content-between"},va=Pe({__name:"ProgressStats",props:{timingStats:{}},setup(n){return(o,s)=>(c(),v("div",ra,[s[3]||(s[3]=e("h6",null,"Progress",-1)),e("div",da,[e("div",ua,[s[0]||(s[0]=e("span",null,"Lines:",-1)),e("span",null,b(n.timingStats.timedLines)+"/"+b(n.timingStats.totalLines),1)]),e("div",ca,[s[1]||(s[1]=e("span",null,"Words:",-1)),e("span",null,b(n.timingStats.timedWords)+"/"+b(n.timingStats.totalWords),1)]),e("div",ma,[s[2]||(s[2]=e("span",null,"Syllables:",-1)),e("span",null,b(n.timingStats.timedSyllables)+"/"+b(n.timingStats.totalSyllables),1)])])]))}});const fa={};function ga(n,o){return c(),v("div",null,[...o[0]||(o[0]=[lt('<h6 data-v-f8f0e233><i class="bi bi-question-circle" data-v-f8f0e233></i> Hotkeys</h6><div class="small" data-v-f8f0e233><div class="hotkey-list mb-2" data-v-f8f0e233><div class="hotkey-item" data-v-f8f0e233><kbd data-v-f8f0e233>Space</kbd><span data-v-f8f0e233>Play/Timing</span></div><div class="hotkey-item" data-v-f8f0e233><kbd data-v-f8f0e233>Enter</kbd><span data-v-f8f0e233>Play/Pause</span></div><div class="hotkey-item" data-v-f8f0e233><kbd data-v-f8f0e233>0</kbd><kbd data-v-f8f0e233>.</kbd><span data-v-f8f0e233>Assign timing</span></div><div class="hotkey-item" data-v-f8f0e233><kbd data-v-f8f0e233>+</kbd><kbd data-v-f8f0e233>-</kbd><span data-v-f8f0e233>Skip short</span></div><div class="hotkey-item" data-v-f8f0e233><kbd data-v-f8f0e233>Ctrl</kbd><kbd data-v-f8f0e233>←</kbd><kbd data-v-f8f0e233>→</kbd><span data-v-f8f0e233>Skip 5s</span></div><div class="hotkey-item" data-v-f8f0e233><kbd data-v-f8f0e233>Alt</kbd><kbd data-v-f8f0e233>T</kbd><span data-v-f8f0e233>Toggle mode</span></div><div class="hotkey-item" data-v-f8f0e233><kbd data-v-f8f0e233>Ctrl</kbd><kbd data-v-f8f0e233>F</kbd><span data-v-f8f0e233>Fast refresh (smoother)</span></div><div class="hotkey-item" data-v-f8f0e233><kbd data-v-f8f0e233>Home</kbd><kbd data-v-f8f0e233>End</kbd><span data-v-f8f0e233>Start/End</span></div><div class="hotkey-item" data-v-f8f0e233><kbd data-v-f8f0e233>Esc</kbd><span data-v-f8f0e233>Exit &quot;Add Timing&quot; mode</span></div></div><div class="timing-steps" data-v-f8f0e233><strong data-v-f8f0e233>Workflow:</strong><ol class="small-steps" data-v-f8f0e233><li data-v-f8f0e233>Start timing mode</li><li data-v-f8f0e233>Press Space to play, then Space during playback to assign timings</li><li data-v-f8f0e233>Edit word boxes manually</li><li data-v-f8f0e233>Adjust syllable timings</li></ol></div></div>',2)])])}const ya=Ue(fa,[["render",ga],["__scopeId","data-v-f8f0e233"]]),ba={class:"mb-3"},ha={class:"small"},pa={class:"d-flex justify-content-between"},wa={class:"text-primary font-monospace"},ka={class:"d-flex justify-content-between"},Ta={class:"text-success font-monospace"},xa=Pe({__name:"ViewportIndicator",props:{viewportWidth:{},currentBreakpoint:{}},setup(n){return(o,s)=>(c(),v("div",ba,[s[2]||(s[2]=e("h6",null,[e("i",{class:"bi bi-display"}),V(" Viewport")],-1)),e("div",ha,[e("div",pa,[s[0]||(s[0]=e("span",null,"Width:",-1)),e("span",wa,b(n.viewportWidth)+"px",1)]),e("div",ka,[s[1]||(s[1]=e("span",null,"Breakpoint:",-1)),e("span",Ta,b(n.currentBreakpoint),1)])])]))}}),$a={key:0,class:"full-width-layout"},Sa={class:"flexible-layout"},Ma={class:"sidebar-column"},Ca={class:"card h-100"},La={class:"card-header py-2"},_a={class:"d-flex align-items-center justify-content-between"},Aa={class:"mb-0"},Pa={class:"text-muted"},Da={class:"card-body"},Ea={class:"main-content-column"},Fa={class:"row mb-3"},Wa={class:"col-6"},Ia={class:"col-6"},Ra={class:"row mb-3"},Ba={class:"col-12"},Na={class:"row mb-3"},ja={class:"col-12"},za={class:"text-muted"},Ua={key:0},qa={key:1,class:"full-width-layout"},Va={key:2,class:"full-width-layout"},Ha={class:"d-flex justify-content-center"},Ka={class:"card",style:{"max-width":"500px"}},Oa={class:"card-body p-5 text-center"},Ga=Pe({__name:"TimingView",setup(n){const o=bt(),s=ht(),f=E(),t=E(null),h=E(!0),l=E(!1),u=E(0),d=E(0),M=E(!1),T=E(0),x=E(null),p=E(null),{analyzeTimingOverlaps:F,fixTimingOverlaps:W}=Dt(),U=E(null),j=E(0),H=E(60),X=E("window"),C=E(typeof window<"u"?window.innerWidth:1024),$=E(typeof window<"u"?window.innerHeight:768);let _=null;const A=E({isPlaying:!1,currentTime:0,duration:0,volume:1,playbackRate:1,isLoaded:!1}),Q=E(!1),ue=O(()=>t.value?Tt(t.value.lyrics):{totalLines:0,timedLines:0,totalWords:0,timedWords:0,totalSyllables:0,timedSyllables:0,completionPercent:0}),we=O(()=>{const a=C.value;return a>=1400?"xxl":a>=1200?"xl":a>=992?"lg":a>=768?"md":a>=576?"sm":"xs"}),ke=O(()=>{var r;if(!((r=t.value)!=null&&r.lyrics))return console.log("🔍 timingEditorWords: No project or lyrics"),[];const a=[];let i=0;return t.value.lyrics.forEach(y=>{Y(y)||!y.words||!Array.isArray(y.words)||(y.words.forEach((L,z)=>{var N;a.push({id:"lyrics-".concat(i,"-word-").concat(z),text:L.word,startTime:(L.startTime||0)/1e3,endTime:(L.endTime||L.startTime||0)/1e3,syllables:(N=L.syllables)==null?void 0:N.map(se=>({text:se.syllable,startTime:(se.startTime||0)/1e3,endTime:(se.endTime||se.startTime||0)/1e3}))})}),i++)}),a}),k=O(()=>A.value.duration||60),P=()=>{l.value=!1},S=()=>{window.history.length>1?s.back():s.push("/compose")},Z=(a,i,r)=>{j.value=a,H.value=i,X.value=r},Y=a=>a.type!==void 0&&a.type!=="lyrics",ce=a=>{if(!t.value)return a;for(let i=a;i<t.value.lyrics.length;i++){const r=t.value.lyrics[i];if(!Y(r)&&r.words&&r.words.length>0)return i}return a},We=a=>{if(!t.value)return a;for(let i=a;i>=0;i--){const r=t.value.lyrics[i];if(!Y(r)&&r.words&&r.words.length>0)return i}return a},Ke=()=>{if(!t.value)return;const a=u.value,i=d.value;if(a>=0&&a<t.value.lyrics.length){const r=t.value.lyrics[a];if(r&&r.words&&i>=0&&i<r.words.length){const y=r.words[i];y.startTime!==void 0&&y.syllables&&y.syllables.length>0&&y.syllables.some(z=>z.startTime===void 0||z.endTime===void 0)&&(t.value.lyrics=Qe(t.value.lyrics,a,i),console.log("🔄 Finalized syllables for current word:",y.word))}}},Oe=a=>{if(!t.value||a>=t.value.lyrics.length){u.value=a;return}const i=t.value.lyrics[a];if(Y(i)){let r=ce(a+1);r===a+1&&r>=t.value.lyrics.length&&(r=We(a-1)),u.value=r;return}if(i.startTime!==void 0&&i.words&&i.words.length>0){u.value=a,d.value=0;const r=i.words[0],y=r.endTime&&r.startTime?r.endTime-r.startTime:500,L=Math.max(0,i.startTime-y);console.log("📍 Smart line selection: Line ".concat(a+1," with timing at ").concat(i.startTime,"ms, seeking to lead-in at ").concat(L,"ms")),J.seek(L)}else{let r=a-1,y=null;for(;r>=0;){const L=t.value.lyrics[r];if(!Y(L)&&L.startTime!==void 0){y=L;break}r--}if(y&&y.startTime!==void 0){console.log("📍 Smart line selection: Line ".concat(a+1," without timing, seeking to previous timed line at ").concat(y.startTime,"ms")),J.seek(y.startTime);const L=r+1;L<t.value.lyrics.length&&!Y(t.value.lyrics[L])?(u.value=L,d.value=0,console.log("📍 Auto-selected next line ".concat(L+1," for timing continuation"))):(u.value=a,d.value=0)}else u.value=a,d.value=0,console.log("📍 Line ".concat(a+1," selected without timing, no previous timed line found"))}},qe=a=>{t.value&&(t.value.lyrics=a)},Me=async()=>{try{A.value.isPlaying?(J.pause(),console.log("Audio paused")):(console.log("Attempting to play audio..."),await J.play(),console.log("Audio play initiated"))}catch(a){console.error("Failed to toggle play/pause:",a),alert("Failed to play audio. The audio context may need to be restarted. Try clicking the play button again.")}},Ge=a=>{J.seek(a)},fe=()=>{const a=Math.max(0,A.value.currentTime-1e4);J.seek(a)},Ce=()=>{var i,r;const a=((r=(i=t.value)==null?void 0:i.audioFile)==null?void 0:r.duration)||0;if(a>0){const y=Math.min(a-100,A.value.currentTime+1e4);J.seek(y)}},Xe=()=>{const a=Math.max(0,A.value.currentTime-1e3);J.seek(a)},me=()=>{var i,r;const a=((r=(i=t.value)==null?void 0:i.audioFile)==null?void 0:r.duration)||0;if(a>0){const y=Math.min(a-100,A.value.currentTime+1e3);J.seek(y)}},Je=()=>{J.seek(0),u.value=ce(0),d.value=0},ge=()=>{var i,r;const a=((r=(i=t.value)==null?void 0:i.audioFile)==null?void 0:r.duration)||0;if(a>0){const y=Math.max(0,a-10);J.seek(y)}},De=()=>{M.value=!M.value},g=async()=>{try{await J.play(),J.pause(),console.log("Audio context verified as ready")}catch(a){console.warn("Audio context may need user interaction:",a)}},m=()=>{if(!t.value)return;const a=u.value,i=t.value.lyrics.length-a,r=i===1?"Clear timing for the current line?":"Clear timing for the current line and ".concat(i-1," lines after it?\n\nThis prevents timing inconsistencies by clearing all subsequent timing.");confirm(r)&&(t.value.lyrics=dt(t.value.lyrics,a),console.log("🗑️ Cleared timing from line ".concat(a," onwards (").concat(i," lines affected)")))},w=(a,i)=>{if(!t.value)return 500;const r=t.value.lyrics,y=r[a];if(!y)return 500;let L;if(i<y.words.length-1)L=y.words[i+1].startTime;else{let N=a+1;for(;N<r.length;){const se=r[N];if(!Y(se)&&se.words.length>0){L=se.words[0].startTime;break}N++}}if(L){const N=A.value.currentTime,se=L/1e3-N;if(rt.isPhraseBreak(se)){const Fe=se*re.autoTiming.phraseBreakSpacing*1e3;return Math.max(re.word.minDuration,Math.min(re.autoTiming.maxPhraseBreakDuration,Fe))}else{const Fe=se*re.autoTiming.normalWordSpacing*1e3;return Math.max(re.word.minDuration,Math.min(re.autoTiming.maxNormalDuration,Fe))}}const z=y.words[i];if(z){const N=z.word.length;return Math.max(200,N*80)}return 500},R=()=>{if(console.log("🎯 assignTiming called",{hasProject:!!t.value,isTimingMode:M.value,isPlaying:A.value.isPlaying,currentLine:u.value,currentWord:d.value,currentTime:A.value.currentTime}),!t.value||!M.value){console.log("❌ assignTiming aborted: missing project or not in timing mode");return}if(!A.value.isPlaying){console.log("❌ assignTiming aborted: audio not playing");return}const a=u.value,i=d.value,r=A.value.currentTime;if(a>=t.value.lyrics.length){console.log("❌ assignTiming aborted: invalid line index");return}const y=t.value.lyrics[a];if(!y||!y.words||i>=y.words.length){console.log("❌ assignTiming aborted: invalid word index");return}const L=w(a,i);t.value.lyrics=xt(t.value.lyrics,a,i,r,L),console.log("✅ Smart timing assigned:",{word:t.value.lyrics[a].words[i].word,startTime:r,duration:L,calculation:L>400?"phrase-break":"normal-spacing"}),B()},B=()=>{var L,z;if(!t.value)return;const a=t.value.lyrics[u.value];if(!a)return;const i=u.value,r=d.value;if(d.value<a.words.length-1)d.value++;else{let N=u.value+1;for(;N<t.value.lyrics.length;){const se=t.value.lyrics[N];if(se.words&&se.words.length>0){u.value=N,d.value=0;break}N++}}const y=u.value!==i||d.value!==r;if(y&&t.value)t.value.lyrics=Qe(t.value.lyrics,i,r);else if(!y&&t.value){const N=(z=(L=t.value.lyrics[i])==null?void 0:L.words)==null?void 0:z[r];N&&N.startTime!==void 0&&N.syllables&&N.syllables.length>0&&(t.value.lyrics=Qe(t.value.lyrics,i,r),console.log("🏁 Finalized syllables for final word:",N.word))}},K=(a,i)=>{if(!t.value)return;const r=t.value.lyrics[a];r&&(r.startTime=i)},D=()=>{t.value&&(t.value.updatedAt=new Date,oe(),console.log("Project saved:",t.value.name))},ee=async a=>{const i=localStorage.getItem("karaokeProjects");if(!i){console.warn("No projects found in storage, redirecting to compose page"),alert("⚠️ No projects found. Redirecting to the compose page."),s.push("/compose");return}try{const y=JSON.parse(i).find(N=>N.id===a);if(!y){console.warn("Project ".concat(a," not found, redirecting to compose page")),alert("⚠️ Project not found. It may have been deleted. Redirecting to the compose page."),s.push("/compose");return}const L={...y,createdAt:new Date(y.createdAt),updatedAt:new Date(y.updatedAt),audioFile:{...y.audioFile,file:null}};if(t.value=L,!await ae(L)){console.warn("Failed to load audio for project ".concat(a,", redirecting to compose page")),alert("⚠️ Could not load the audio file for this project. Please check if the file still exists or try re-importing it. Redirecting to the compose page."),s.push("/compose");return}u.value=ce(0),d.value=0,h.value=!1}catch(r){console.error("Error loading project:",r),alert("⚠️ Error loading project: ".concat(r,". Redirecting to the compose page.")),s.push("/compose")}},ae=async a=>{var i;if(!a.audioFile)return console.error("No audio file in project"),!1;console.log("🔄 Loading project audio:",{projectName:a.name,audioFileName:a.audioFile.name,hasFile:!!a.audioFile.file,hasStoredData:!!a.audioFile.storedData,storageType:(i=a.audioFile.storedData)==null?void 0:i.storageType,duration:a.audioFile.duration});try{let r=a.audioFile;if(!r.file&&r.storedData){console.log("Retrieving stored audio file...");const z=await $t.retrieveAudioFile(r.storedData);if(z)r={...r,...z},a.audioFile=r,console.log("✅ Audio file retrieved successfully");else return console.error("Failed to retrieve audio file"),!1}let y=!1,L=3;for(;!y&&L>0;)try{if(console.log("Attempting to load audio (".concat(4-L,"/3)...")),y=await J.loadAudioFile(r),y){const z=J.getPlaybackState();if(A.value={...z},(!a.audioFile.duration||a.audioFile.duration!==z.duration)&&(console.log("💾 Storing detected audio duration:",z.duration/1e3,"seconds"),a.audioFile.duration=z.duration,a.updatedAt=new Date,oe()),!x.value){const N=await J.generateWaveformData(1e3);N&&(x.value={peaks:N,sampleRate:44100,duration:z.duration,channels:1})}console.log("✅ Audio loaded successfully");break}else L--,L>0&&(console.warn("Audio loading failed, retrying... (".concat(L," attempts left)")),await new Promise(z=>setTimeout(z,1e3)))}catch(z){console.error("Audio loading attempt failed:",z),L--,L>0&&await new Promise(N=>setTimeout(N,1e3))}return y?!0:(console.error("Failed to load audio after multiple attempts"),!1)}catch(r){return console.error("Error loading project audio:",r),!1}},oe=()=>{if(t.value)try{const a=localStorage.getItem("karaokeProjects"),i=a?JSON.parse(a):[],r=i.findIndex(y=>y.id===t.value.id);if(r!==-1){const y={...t.value,audioFile:{...t.value.audioFile,file:null,url:void 0}};i[r]=y,localStorage.setItem("karaokeProjects",JSON.stringify(i)),console.log("💾 Project saved to storage")}}catch(a){console.error("Error saving project:",a)}},Le=()=>{let a=0;J.onTimeUpdate(i=>{if(A.value.currentTime=i,a>5e3&&i<1e3&&(u.value=ce(0),d.value=0,console.log("🔄 Audio reset detected, resetting to first lyric line")),a=i,t.value&&A.value.isPlaying&&!M.value){const r=at(t.value.lyrics,i),y=t.value.lyrics[r.lineIndex];y&&!Y(y)&&(u.value=r.lineIndex,d.value=r.wordIndex),A.value.currentWord={lineIndex:r.lineIndex,wordIndex:r.wordIndex},A.value.currentSyllable={lineIndex:r.lineIndex,wordIndex:r.wordIndex,syllableIndex:r.syllableIndex}}else if(t.value&&A.value.isPlaying&&M.value){const r=at(t.value.lyrics,i);A.value.currentWord={lineIndex:r.lineIndex,wordIndex:r.wordIndex},A.value.currentSyllable={lineIndex:r.lineIndex,wordIndex:r.wordIndex,syllableIndex:r.syllableIndex}}}),J.onPlaybackStateChange(i=>{A.value={...i}})},Ee=()=>{const a=i=>{if(!(i.target instanceof HTMLInputElement||i.target instanceof HTMLTextAreaElement))switch(i.code){case"Space":i.preventDefault(),M.value&&A.value.isPlaying?R():Me();break;case"NumpadEnter":case"Enter":!i.ctrlKey&&!i.metaKey&&(i.preventDefault(),Me());break;case"Numpad0":case"NumpadDecimal":i.preventDefault(),M.value&&R();break;case"NumpadAdd":i.preventDefault(),me();break;case"NumpadSubtract":i.preventDefault(),Xe();break;case"KeyT":i.preventDefault(),De();break;case"Insert":i.preventDefault(),De();break;case"KeyP":(i.ctrlKey||i.metaKey)&&(i.preventDefault(),Me());break;case"KeyS":(i.ctrlKey||i.metaKey)&&(i.preventDefault(),D());break;case"KeyL":(i.ctrlKey||i.metaKey)&&(i.preventDefault(),fe());break;case"KeyR":(i.ctrlKey||i.metaKey)&&(i.preventDefault(),Ce());break;case"Home":i.preventDefault(),Je();break;case"End":i.preventDefault(),ge();break;case"ArrowLeft":(i.ctrlKey||i.metaKey)&&(i.preventDefault(),fe());break;case"ArrowRight":(i.ctrlKey||i.metaKey)&&(i.preventDefault(),Ce());break;case"KeyF":(i.ctrlKey||i.metaKey)&&(i.preventDefault(),J.toggleFastMode(),Q.value=J.getFastMode(),console.log("🔄 Toggled fast refresh mode"));break;case"Escape":i.preventDefault(),l.value?P():M.value&&(Ke(),M.value=!1);break}};return window.addEventListener("keydown",a),()=>{window.removeEventListener("keydown",a)}},te=()=>{var a;if(!((a=t.value)!=null&&a.lyrics)){console.log("❌ Musical timing: No project or lyrics available");return}console.log("🎵 Applying musical timing to song...");try{const i=At(t.value.lyrics);p.value=i,console.log("✅ Musical timing applied successfully",i)}catch(i){console.error("❌ Error applying musical timing:",i)}},ie=()=>{var a;if(!((a=t.value)!=null&&a.lyrics)){console.log("❌ Reset timing: No project or lyrics available");return}console.log("🔄 Resetting all syllable timing...");try{Pt(t.value.lyrics),p.value=null,console.log("✅ Syllable timing reset successfully")}catch(i){console.error("❌ Error resetting syllable timing:",i)}},ye=()=>{var a;if(!((a=t.value)!=null&&a.lyrics)){console.log("❌ Timing analysis: No project or lyrics available");return}console.log("🔍 Analyzing timing overlaps...");try{const i=F(t.value.lyrics);U.value=i,console.log("✅ Timing analysis completed:",i.summary),i.overlaps.length>0&&(console.warn("Found ".concat(i.overlaps.length," timing overlaps:")),i.overlaps.forEach((r,y)=>{console.warn("  ".concat(y+1,'. "').concat(r.word1.word,'" → "').concat(r.word2.word,'" (').concat(r.overlapDuration,"ms overlap)"))}))}catch(i){console.error("❌ Error analyzing timing:",i)}},be=async()=>{var a;if(!((a=t.value)!=null&&a.lyrics)){console.log("❌ Fix overlaps: No project or lyrics available");return}console.log("🔧 Fixing timing overlaps...");try{const i=W(t.value.lyrics);i.fixCount>0?(console.log("✅ Fixed ".concat(i.fixCount," timing overlaps:")),i.details.forEach(r=>console.log("  • ".concat(r))),await D(),T.value++,await Se(),ye(),console.log("🔄 Visual refresh triggered after timing fix")):console.log("✅ No overlaps to fix!")}catch(i){console.error("❌ Error fixing timing overlaps:",i)}},_e=a=>{var r;if(!((r=t.value)!=null&&r.lyrics)){console.error("❌ No project lyrics to update");return}const i=t.value.lyrics.filter(y=>!Y(y));a.forEach(y=>{const L=y.id.match(/lyrics-(\d+)-word-(\d+)/);if(L){const z=parseInt(L[1]),N=parseInt(L[2]);if(z<i.length){const se=i[z];if(N<se.words.length){const I=se.words[N],Fe=I.startTime||0,Ye=I.endTime||0,he=Math.round(y.startTime*1e3),pe=Math.round(y.endTime*1e3);let et=!1;if(y.syllables&&I.syllables&&y.syllables.length===I.syllables.length&&(et=y.syllables.some((ve,Ve)=>{const Te=I.syllables[Ve],Re=Math.round(ve.startTime*1e3),Be=Math.round(ve.endTime*1e3);return Math.abs(Re-(Te.startTime||0))>1||Math.abs(Be-(Te.endTime||0))>1})),et&&y.syllables)I.syllables=y.syllables.map(ve=>({syllable:ve.text,startTime:Math.round(ve.startTime*1e3),endTime:Math.round(ve.endTime*1e3)})),I.startTime=he,I.endTime=pe,I.duration=pe-he;else if(I.syllables&&I.syllables.length>0)try{const ve=I.syllables.map(xe=>({text:xe.syllable||"",startTime:xe.startTime||0,endTime:xe.endTime||0})),Ve=Mt.fromAbsoluteSyllables("word-".concat(z,"-").concat(N),I.word,Fe,Ye,ve);let Te;const Re=Math.abs(he-Fe)>10,Be=Math.abs(pe-Ye)>10;if(Re&&!Be){Te=Ve.moveWord(he);const xe=Te.getWordData(),Ae=Te.getAbsoluteSyllables();I.startTime=xe.startTime,I.endTime=xe.endTime,I.duration=I.endTime-I.startTime,I.syllables=Ae.map(Ne=>({syllable:Ne.text,startTime:Ne.startTime,endTime:Ne.endTime,duration:Ne.endTime-Ne.startTime}))}else if(Be&&!Re)I.endTime=pe,I.duration=pe-(I.startTime||0);else if(Re&&Be){Te=Ve.moveWord(he);const xe=Te.getAbsoluteSyllables();I.startTime=he,I.endTime=pe,I.duration=pe-he,I.syllables=xe.map(Ae=>({syllable:Ae.text,startTime:Ae.startTime,endTime:Ae.endTime,duration:Ae.endTime-Ae.startTime}))}}catch(ve){console.error('❌ Error using RelativeSyllableTiming for "'.concat(I.word,'":'),ve),I.startTime=he,I.endTime=pe,I.duration=I.endTime-I.startTime}else I.startTime=he,I.endTime=pe,I.duration=I.endTime-I.startTime}}}})},Ie=a=>{console.log("🎯 Word selected:",a)};return ot(async()=>{const a=o.params.projectId;a?await ee(a):h.value=!1,Le(),_=Ee(),setTimeout(()=>{f.value&&(f.value.focus(),console.log("TimingView focused for hotkey support"))},100);const r=()=>{C.value=window.innerWidth,$.value=window.innerHeight};window.addEventListener("resize",r);const y=_;_=()=>{y&&y(),window.removeEventListener("resize",r)}}),gt(()=>{J.pause(),_&&_()}),(a,i)=>{var y,L,z,N;const r=pt("router-link");return c(),v("div",{class:"timing-view",tabindex:"0",ref_key:"timingViewRef",ref:f,onClick:g},[t.value?(c(),v("div",$a,[e("div",Sa,[e("div",Ma,[e("div",Ca,[e("div",La,[e("div",_a,[e("div",null,[e("h6",Aa,b((y=t.value)==null?void 0:y.name),1),e("small",Pa,b((L=t.value)==null?void 0:L.artist),1)]),e("div",{class:"btn-group-vertical btn-group-sm"},[e("button",{class:"btn btn-success btn-sm",onClick:D,title:"Save project (Ctrl+S)","data-bs-toggle":"tooltip"},[...i[1]||(i[1]=[e("i",{class:"bi bi-save"},null,-1)])]),e("button",{class:"btn btn-outline-secondary btn-sm",onClick:S,title:"Exit to previous page","data-bs-toggle":"tooltip"},[...i[2]||(i[2]=[e("i",{class:"bi bi-x-circle"},null,-1)])])])])]),e("div",Da,[$e(la,{"is-timing-mode":M.value,"timed-words":ue.value.timedWords,"total-words":ue.value.totalWords,"song-analysis":p.value,"timing-analysis":U.value,onToggleTimingMode:De,onClearTiming:m,onApplyMusicalTiming:te,onResetSyllableTiming:ie,onAnalyzeTiming:ye,onFixOverlaps:be},null,8,["is-timing-mode","timed-words","total-words","song-analysis","timing-analysis"]),$e(va,{"timing-stats":ue.value},null,8,["timing-stats"]),$e(xa,{"viewport-width":C.value,"current-breakpoint":we.value},null,8,["viewport-width","current-breakpoint"]),$e(ya)])])]),e("div",Ea,[e("div",Fa,[e("div",Wa,[$e(di,{lyrics:t.value.lyrics,currentLine:u.value,currentWord:d.value,isTimingMode:M.value,onLineSelect:Oe,onLyricsUpdate:qe},null,8,["lyrics","currentLine","currentWord","isTimingMode"])]),e("div",Ia,[$e(Ui,{lyrics:t.value.lyrics,currentTime:A.value.currentTime,currentLine:u.value,currentWord:d.value,currentSyllable:M.value?0:(z=A.value.currentSyllable)==null?void 0:z.syllableIndex},null,8,["lyrics","currentTime","currentLine","currentWord","currentSyllable"])])]),e("div",Ra,[e("div",Ba,[$e(Ds,{audioFile:t.value.audioFile,lyrics:t.value.lyrics,currentTime:A.value.currentTime,waveformData:x.value,playbackState:A.value,isTimingMode:M.value,onSeek:Ge,onLyricsPosition:K,onPlayPause:Me,onSkipBackward:fe,onSkipForward:Ce,onViewWindowChange:Z},{"above-waveform":it(()=>[(c(),wt(St,{key:"timing-editor-".concat(T.value),words:ke.value,duration:k.value,"view-start":j.value,"view-end":H.value,"show-debug":!1,"onUpdate:words":_e,onSelectWord:Ie},null,8,["words","duration","view-start","view-end"]))]),_:1},8,["audioFile","lyrics","currentTime","waveformData","playbackState","isTimingMode"])])]),e("div",Na,[e("div",ja,[e("small",za,[V(" 🎯 "+b(M.value?"Timing":"Playback")+" Mode: Line "+b(u.value)+" , Word "+b(d.value+1)+" ",1),(N=t.value.lyrics[u.value])!=null&&N.words[d.value]?(c(),v("span",Ua," ("+b(t.value.lyrics[u.value].words[d.value].word)+") ",1)):q("",!0),e("span",{class:G(["ms-3",Q.value?"text-success fw-bold":"text-muted"])}," 🔄 "+b(Q.value?"12Hz FAST":"8Hz Normal"),3)])])])])])])):h.value?(c(),v("div",qa,[...i[3]||(i[3]=[e("div",{class:"text-center py-5"},[e("div",{class:"spinner-border text-primary",role:"status"},[e("span",{class:"visually-hidden"},"Loading...")]),e("p",{class:"mt-3"},"Loading project...")],-1)])])):(c(),v("div",Va,[e("div",Ha,[e("div",Ka,[e("div",Oa,[i[5]||(i[5]=e("h3",null,"Project Not Found",-1)),i[6]||(i[6]=e("p",{class:"lead"},"The requested project could not be found.",-1)),$e(r,{to:"/compose",class:"btn btn-primary"},{default:it(()=>[...i[4]||(i[4]=[e("i",{class:"bi bi-arrow-left"},null,-1),V(" Back to Projects ",-1)])]),_:1})])])])])),l.value?(c(),v("div",{key:3,class:G(["modal",{show:l.value}]),onClick:P},[e("div",{class:"modal-dialog modal-lg",onClick:i[0]||(i[0]=yt(()=>{},["stop"]))},[e("div",{class:"modal-content"},[e("div",{class:"modal-header"},[i[7]||(i[7]=e("h5",{class:"modal-title"},"🎹 Hotkey Reference Guide",-1)),e("button",{type:"button",class:"btn-close",onClick:P})]),i[8]||(i[8]=lt('<div class="modal-body" data-v-6a1b7887><div class="row" data-v-6a1b7887><div class="col-md-6" data-v-6a1b7887><h6 class="text-primary" data-v-6a1b7887>⏯️ Playback Controls</h6><ul class="list-unstyled mb-4" data-v-6a1b7887><li class="mb-2" data-v-6a1b7887><kbd data-v-6a1b7887>Spacebar</kbd> - Play/Pause (or Timing in Timing Mode)</li><li class="mb-2" data-v-6a1b7887><kbd data-v-6a1b7887>Numpad Enter</kbd> - Play/Pause</li><li class="mb-2" data-v-6a1b7887><kbd data-v-6a1b7887>Ctrl+P</kbd> - Play/Pause</li></ul><h6 class="text-success" data-v-6a1b7887>⏩ Navigation</h6><ul class="list-unstyled mb-4" data-v-6a1b7887><li class="mb-2" data-v-6a1b7887><kbd data-v-6a1b7887>Home</kbd> - Jump to start (0:00)</li><li class="mb-2" data-v-6a1b7887><kbd data-v-6a1b7887>End</kbd> - Jump to end of song</li><li class="mb-2" data-v-6a1b7887><kbd data-v-6a1b7887>Numpad +</kbd> - Skip forward 1 second</li><li class="mb-2" data-v-6a1b7887><kbd data-v-6a1b7887>Numpad -</kbd> - Skip backward 1 second</li><li class="mb-2" data-v-6a1b7887><kbd data-v-6a1b7887>Ctrl+R</kbd> - Skip forward 10 seconds</li><li class="mb-2" data-v-6a1b7887><kbd data-v-6a1b7887>Ctrl+L</kbd> - Skip backward 10 seconds</li></ul></div><div class="col-md-6" data-v-6a1b7887><h6 class="text-warning" data-v-6a1b7887>⏱️ Timing Assignment</h6><ul class="list-unstyled mb-4" data-v-6a1b7887><li class="mb-2" data-v-6a1b7887><kbd data-v-6a1b7887>Spacebar</kbd> - Assign timing (in Timing Mode)</li><li class="mb-2" data-v-6a1b7887><kbd data-v-6a1b7887>Numpad 0</kbd> or <kbd data-v-6a1b7887>.</kbd> - Assign timing</li><li class="mb-2" data-v-6a1b7887><kbd data-v-6a1b7887>T</kbd> or <kbd data-v-6a1b7887>Insert</kbd> - Toggle Timing Mode</li></ul><h6 class="text-info" data-v-6a1b7887>📝 Editing</h6><ul class="list-unstyled mb-4" data-v-6a1b7887><li class="mb-2" data-v-6a1b7887><kbd data-v-6a1b7887>Ctrl+S</kbd> - Save project</li><li class="mb-2" data-v-6a1b7887><kbd data-v-6a1b7887>Escape</kbd> - Close modal or exit timing mode</li><li class="mb-2" data-v-6a1b7887><kbd data-v-6a1b7887>Double-click</kbd> any lyric line to edit</li><li class="mb-2" data-v-6a1b7887><kbd data-v-6a1b7887>Enter</kbd> or <kbd data-v-6a1b7887>Blur</kbd> to save</li><li class="mb-2" data-v-6a1b7887><kbd data-v-6a1b7887>Escape</kbd> to cancel</li></ul></div></div><div class="alert alert-info mt-3" data-v-6a1b7887><strong data-v-6a1b7887>💡 Pro Tips:</strong><ul class="mb-0 mt-2" data-v-6a1b7887><li data-v-6a1b7887>Use <kbd data-v-6a1b7887>Home</kbd>/<kbd data-v-6a1b7887>End</kbd> for instant navigation to start/end</li><li data-v-6a1b7887>Use the numpad for fastest timing assignment workflow</li><li data-v-6a1b7887>Toggle Timing Mode (<kbd data-v-6a1b7887>T</kbd> or <kbd data-v-6a1b7887>Insert</kbd>) to focus on timing vs playback</li><li data-v-6a1b7887>Double-click lyrics for quick inline editing</li><li data-v-6a1b7887>Use 1-second skips for precise timing adjustments</li></ul></div></div>',1)),e("div",{class:"modal-footer"},[e("button",{type:"button",class:"btn btn-primary",onClick:P},"Got it!")])])])],2)):q("",!0)],512)}}});const en=Ue(Ga,[["__scopeId","data-v-6a1b7887"]]);export{en as default};
//# sourceMappingURL=TimingView-4230ba05.js.map
