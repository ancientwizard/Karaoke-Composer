System.register([],function(e,t){"use strict";return{execute:function(){e({b:s,c:function(e,t){const i=[...e];for(let n=t;n<i.length;n++){const e=i[n];e.type&&"lyrics"!==e.type||(e.startTime=void 0,e.endTime=void 0,e.duration=void 0,e.words&&e.words.forEach(e=>{e.startTime=void 0,e.endTime=void 0,e.duration=void 0,e.syllables&&e.syllables.forEach(e=>{e.startTime=void 0,e.endTime=void 0,e.duration=void 0})}))}return i},d:function(e){let t=0,i=0,n=0,s=0,r=0;e.forEach(e=>{void 0!==e.startTime&&void 0!==e.endTime&&r++,e.words.forEach(e=>{t++,void 0!==e.startTime&&void 0!==e.endTime&&i++,e.syllables.forEach(e=>{n++,void 0!==e.startTime&&void 0!==e.endTime&&s++})})});const l=n>0?Math.round(s/n*100):0;return{totalLines:e.length,timedLines:r,totalWords:t,timedWords:i,totalSyllables:n,timedSyllables:s,completionPercent:l}},e:function(e,t,i,s,l=500){const o=[...e],a=o[t];if(a&&a.words[i]){const e=a.words[i];if(e.startTime=s,e.endTime=s+l,e.duration=l,e.syllables.forEach(e=>{e.startTime=void 0,e.endTime=void 0,e.duration=void 0}),i>0){const e=a.words[i-1];if(void 0!==e.startTime){const t=s-e.startTime,i=n.getConservativeDuration(t,!1);r(e,e.startTime,i)}}else if(t>0){const e=o[t-1];if(e&&e.words.length>0){const t=e.words[e.words.length-1];if(void 0!==t.startTime){const e=s-t.startTime,i=n.getConservativeDuration(e,!0);r(t,t.startTime,i)}}}!function(e){const t=e.words.filter(e=>void 0!==e.startTime&&void 0!==e.endTime);if(t.length>0){const i=t.map(e=>e.startTime).filter(e=>void 0!==e),n=t.map(e=>e.endTime).filter(e=>void 0!==e);e.startTime=Math.min(...i),e.endTime=Math.max(...n),e.duration=e.endTime-e.startTime}}(a)}return o},f:function(e,t,i,n=500){const s=[...e],l=s[t];if(l&&l.words[i]){const e=l.words[i];void 0!==e.startTime&&e.syllables.some(e=>void 0===e.startTime)&&r(e,e.startTime,n)}return s},g:function(e,i){const n=new t({silent:!0});n.loadLyrics(e);const s=n.getCurrentPosition(i),r={lineIndex:s.lineIndex,wordIndex:s.wordIndex,syllableIndex:s.syllableIndex,line:void 0,word:void 0,syllable:void 0};if(s.isActive&&s.lineIndex<e.length){const t=e[s.lineIndex];if(r.line=t,s.wordIndex<t.words.length){const e=t.words[s.wordIndex];r.word=e,s.syllableIndex<e.syllables.length&&(r.syllable=e.syllables[s.syllableIndex])}}return r},p:function(e){if(!e||"string"!=typeof e)return{lyrics:[],metadata:{}};const t=e.split("\n").map(e=>e.trim()).filter(e=>e.length>0),i=[],n={};let r=1,l=null;t.forEach((e,t)=>{const o=function(e){const t=e.trim(),i=t.match(/^\[@TITLE:(.+)\]/);if(i)return{type:"title",value:i[1].trim()};const n=t.match(/^\[@AUTHOR:(.+)\]/);if(n)return{type:"author",value:n[1].trim()};const s=t.match(/^\[@CAPTION:(.+)\]/);return s?{type:"caption",value:s[1].trim()}:null}(e);if(o){const s={id:`metadata-${t}`,lineNumber:r,text:e,words:[],type:o.type,metadata:{[o.type]:o.value}};"title"===o.type?n.title=o.value:"author"===o.type?n.author=o.value:"caption"===o.type&&(n.captions||(n.captions=[]),n.captions.push(o.value),l=o.value),i.push(s),r++}else{const t=s(e,r,`line-${r}`);t.type="lyrics",l&&(t.metadata||(t.metadata={}),t.metadata.caption=l,l=null),i.push(t),r++}});const o=i.findIndex(e=>"title"===e.type);if(o>0){const e=i.splice(o,1)[0];i.unshift(e),i.forEach((e,t)=>{e.lineNumber=t+1})}return{lyrics:i,metadata:n}}});class t{lyrics=[];eventLog=[];config;silent;constructor(e){this.silent=e?.silent||!1,this.config={syllableWeights:{first:.7,middle:.8,last:2},gaps:{shortPause:100,mediumPause:300,longPause:800},minimums:{syllableDuration:150,wordDuration:200,lineDuration:1e3},...e},this.log("ENGINE_INIT",0,-1,void 0,void 0,"Karaoke Timing Engine initialized")}loadLyrics(e){this.lyrics=[...e],this.eventLog=[],this.log("LYRICS_LOADED",0,-1,void 0,void 0,`Loaded ${e.length} lines`)}assignWordTiming(e,t,i){const n=[];if(!this.isValidPosition(e,t))return this.log("ERROR_INVALID_POSITION",i,e,t),n;const s=this.lyrics[e].words[t],r=this.getPreviousWord(e,t);if(r&&void 0!==r.word.startTime){const l=i-r.word.startTime;this.finalizeWordTiming(r,l,i),n.push({type:"word_end",timestamp:i,lineIndex:r.lineIndex,wordIndex:r.wordIndex,text:r.word.word,expectedDuration:l});const o=this.detectGap(s.word,l);o>this.config.gaps.shortPause&&n.push({type:"phrase_gap",timestamp:i,lineIndex:e,wordIndex:t,expectedDuration:o})}return s.startTime=i,s.endTime=void 0,n.push({type:"word_start",timestamp:i,lineIndex:e,wordIndex:t,text:s.word}),this.log("WORD_ASSIGNED",i,e,t,void 0,s.word),n}finalizeAllTiming(e){const t=[],i=this.findLastTimedWord();if(i&&void 0!==i.word.startTime){const n=this.estimateWordDuration(i.word);this.finalizeWordTiming(i,n,e),t.push({type:"word_end",timestamp:e,lineIndex:i.lineIndex,wordIndex:i.wordIndex,text:i.word.word,expectedDuration:n})}return this.log("TIMING_FINALIZED",e,-1),t}getCurrentPosition(e){for(let t=0;t<this.lyrics.length;t++){const i=this.lyrics[t];for(let n=0;n<i.words.length;n++){const s=i.words[n];if(void 0!==s.startTime)if(void 0!==s.endTime){if(e>=s.startTime&&e<s.endTime)return{lineIndex:t,wordIndex:n,syllableIndex:this.findCurrentSyllable(s,e),isActive:!0}}else if(e>=s.startTime){const i=this.getNextWord(t,n);if(!i||void 0===i.word.startTime||e<i.word.startTime)return{lineIndex:t,wordIndex:n,syllableIndex:this.findCurrentSyllable(s,e),isActive:!0}}}}return{lineIndex:0,wordIndex:0,syllableIndex:0,isActive:!1}}getEventLog(){return[...this.eventLog]}getStats(){let e=0,t=0,i=0,n=0,s=0;return this.lyrics.forEach(r=>{r.words.forEach(r=>{e++,void 0!==r.startTime&&(t++,void 0!==r.endTime&&(s+=r.endTime-r.startTime)),r.syllables.forEach(e=>{i++,void 0!==e.startTime&&void 0!==e.endTime&&n++})})}),{totalWords:e,timedWords:t,totalSyllables:i,timedSyllables:n,averageWordDuration:t>0?s/t:0,completionPercent:e>0?t/e*100:0,eventCount:this.eventLog.length}}isValidPosition(e,t){return e>=0&&e<this.lyrics.length&&t>=0&&t<this.lyrics[e].words.length}getPreviousWord(e,t){if(t>0)return{lineIndex:e,wordIndex:t-1,word:this.lyrics[e].words[t-1]};if(e>0){const t=this.lyrics[e-1];if(t.words.length>0)return{lineIndex:e-1,wordIndex:t.words.length-1,word:t.words[t.words.length-1]}}return null}getNextWord(e,t){const i=this.lyrics[e];if(t<i.words.length-1)return{lineIndex:e,wordIndex:t+1,word:i.words[t+1]};if(e<this.lyrics.length-1){const t=this.lyrics[e+1];if(t.words.length>0)return{lineIndex:e+1,wordIndex:0,word:t.words[0]}}return null}finalizeWordTiming(e,t,i){const{word:n}=e;n.endTime=i,n.duration=t,this.distributeSyllableTiming(n,t),this.log("WORD_FINALIZED",i,e.lineIndex,e.wordIndex,void 0,`${n.word} (${t}ms)`)}distributeSyllableTiming(e,t){if(e.syllables.length<=1)return void(e.syllables[0]&&void 0!==e.startTime&&(e.syllables[0].startTime=e.startTime,e.syllables[0].endTime=e.startTime+t,e.syllables[0].duration=t));const i=e.syllables.map((t,i)=>0===i?this.config.syllableWeights.first:i===e.syllables.length-1?this.config.syllableWeights.last:this.config.syllableWeights.middle),n=i.reduce((e,t)=>e+t,0),s=i.map(e=>e/n*t);let r=e.startTime;e.syllables.forEach((e,t)=>{e.startTime=r,e.endTime=r+s[t],e.duration=s[t],r=e.endTime,this.log("SYLLABLE_TIMED",e.startTime,-1,-1,t,`${e.syllable} (${s[t].toFixed(1)}ms)`)})}detectGap(e,t){return e.includes(",")||e.includes(";")?this.config.gaps.shortPause:e.includes(".")||e.includes("!")||e.includes("?")||t>2*this.config.minimums.wordDuration?this.config.gaps.mediumPause:0}findLastTimedWord(){for(let e=this.lyrics.length-1;e>=0;e--){const t=this.lyrics[e];for(let i=t.words.length-1;i>=0;i--){const n=t.words[i];if(void 0!==n.startTime)return{lineIndex:e,wordIndex:i,word:n}}}return null}estimateWordDuration(e){const t=e.syllables.length;return this.config.minimums.wordDuration+(t-1)*this.config.minimums.syllableDuration}findCurrentSyllable(e,t){if(e.syllables.some(e=>void 0!==e.startTime&&void 0!==e.endTime)){for(let i=0;i<e.syllables.length;i++){const n=e.syllables[i];if(void 0!==n.startTime&&void 0!==n.endTime&&t>=n.startTime&&t<n.endTime)return i}return Math.max(0,e.syllables.length-1)}{if(void 0===e.startTime||e.syllables.length<=1)return 0;const i=t-e.startTime;for(let t=0;t<e.syllables.length;t++)if(i<(t+1)*this.config.minimums.syllableDuration)return Math.max(0,t);return e.syllables.length-1}}log(e,t,i,n,s,r){const l=`[${t.toFixed(0).padStart(6)}ms] ${e.padEnd(20)} L:${i.toString().padStart(2)} W:${(n??-1).toString().padStart(2)} S:${(s??-1).toString().padStart(2)} ${r||""}`;this.silent||console.log(l),this.eventLog.push({type:e,timestamp:t,lineIndex:i,wordIndex:n,syllableIndex:s,text:r})}}const i=e("a",{word:{minDuration:100,maxDuration:2e3,collisionMargin:50,defaultDuration:500},syllable:{minDuration:50,defaultDuration:200,lastSyllableWeight:2,firstSyllableWeight:.8,weightIncrement:.1},autoTiming:{normalWordSpacing:.6,phraseBreakSpacing:.25,phraseBreakThreshold:3,maxNormalDuration:600,maxPhraseBreakDuration:800,conservativeGapUsage:.7,lineEndingGapUsage:.5},musical:{restDuration:{comma:200,period:800,breath:300,phrase:600},notePatterns:{eighth:125,quarter:250,half:500,whole:1e3},conservativeMultiplier:.7},editor:{pixelThreshold:5,snapThreshold:10,viewportBuffer:100,dragSensitivity:1},validation:{gapTolerance:3,overlapTolerance:3,durationTolerance:1,timingPrecision:1},refresh:{playbackUpdateHz:8,fastModeMultiplier:1.5,dragUpdateHz:60}});class n{static calculateSyllableWeights(e){return Array.from({length:e},(t,n)=>n===e-1?i.syllable.lastSyllableWeight:i.syllable.firstSyllableWeight+n*i.syllable.weightIncrement)}static isPhraseBreak(e){return e>i.autoTiming.phraseBreakThreshold}static getConservativeDuration(e,t=!1){return e*(t?i.autoTiming.lineEndingGapUsage:i.autoTiming.conservativeGapUsage)}static constrainDuration(e,t=!0){const n=t?i.word.minDuration:i.syllable.minDuration,s=t?i.word.maxDuration:i.word.maxDuration/2;return Math.max(n,Math.min(s,e))}static roundTiming(e){return Math.round(e/i.validation.timingPrecision)*i.validation.timingPrecision}static getPlaybackUpdateInterval(e=!1){return 1e3/(e?i.refresh.playbackUpdateHz*i.refresh.fastModeMultiplier:i.refresh.playbackUpdateHz)}static getDragUpdateInterval(){return 1e3/i.refresh.dragUpdateHz}}function s(e,t,i){const n=[];return e.split(/\s+/).filter(e=>e.length>0).forEach(e=>{const t=e.split("/").filter(e=>e.length>0),i=t.map(e=>({syllable:e})),s=t.join("");n.push({word:s,syllables:i})}),{id:i,lineNumber:t,text:e,words:n}}function r(e,t,s){if(e.syllables.length<=1)e.syllables[0]&&(e.syllables[0].startTime=t,e.syllables[0].endTime=t+s,e.syllables[0].duration=s);else{const r=e.syllables.length,l=i.syllable.minDuration*r;s<l&&(console.warn(`⚠️ Word "${e.word}" duration (${s}ms) too short for ${r} syllables. Extending to ${l}ms`),s=l);const o=n.calculateSyllableWeights(r),a=o.reduce((e,t)=>e+t,0),d=s-l;let m=t;e.syllables.forEach((e,t)=>{const s=i.syllable.minDuration,r=o[t]/a*d,l=n.constrainDuration(s+r,!1);e.startTime=m,e.endTime=m+l,e.duration=l,m=e.endTime})}e.endTime=t+s,e.duration=s}e("T",n)}}});
//# sourceMappingURL=lyricsParser-legacy-fd32a37b.js.map
