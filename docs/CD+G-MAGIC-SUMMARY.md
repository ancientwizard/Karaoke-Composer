# CD+G Magic Reference Summary

## Overview

This document summarizes the key architectural insights and configuration details from **CD+Graphics Magic** (`reference/cd+g-magic/`), the reference implementation that our CDG generator is designed to replicate.

> **Critical Note**: The reference code in `reference/cd+g-magic/CDG_Magic/Source/` is the **gospel truth** for understanding CDG format semantics. Always consult it when understanding is unclear. Never guess—verify against the source.

---

## Key Time Unit: Packets at 300 pps

### Fundamental Constant

```
CDG Playback Rate: 300 packets per second
Display Frame Rate: 75 frames per second
Packets per Frame: 4 (300 ÷ 75)
Packets per Minute: 18,000 (300 × 60)
Packet Size: 24 bytes
```

### Time Conversion Formula

```
Time (seconds) = Packet Count ÷ 300
Packet Count = Time (seconds) × 300
Packet Count = Time (frames) × 4
```

**Critical Understanding**: All timing values in CD+Graphics Magic's internal format (MediaEvent structs, clip start/duration) are expressed in **packet units at 300 pps**, not milliseconds.

#### Reference Code Evidence

From `CDGMagic_TextClip.cpp`:
```cpp
// The "steps" then determine the actual fade time, 8 * 10 = 80 packs / 300 per second = 266ms
```

From time display code:
```cpp
int actual_time = current_clip->start_pack() + temp_event->start_offset;
snprintf(label_buffer, "%02i:%02i.%02i",
         actual_time / 18000,      // Minutes
         (actual_time / 300) % 60, // Seconds
         (actual_time % 300) / 4); // Frames at 75fps
```

---

## Project Data Flow

### Source Material → Extraction → Generation

```
reference/cd+g-magic/Sample_Files/sample_project_04.cmp
    ↓ (extract via parse-cmp.ts)
diag/sample_project_04.json
    ↓ (generate via generate-cdg-from-json.ts)
output.cdg
    ↓ (compare against)
reference/cd+g-magic/Sample_Files/sample_project_04.cdg (reference output)
```

### Extraction Script

**File**: `src/debug/parse-cmp.ts`

**Purpose**: Parse the binary CD+Graphics Magic project format (.cmp) and convert to JSON

**Usage**:
```bash
npx tsx src/debug/parse-cmp.ts <project.cmp> [output.json]
```

**Key Functions**:
- `parseProject()` - Main entry point, reads project header and all clips
- `parseBMPClip()` - Parses bitmap clip data (images, transitions, positioning)
- `parseTextClip()` - Parses text clip data (font, timing, color, karaoke mode)

**Output Structure**: 
The JSON matches the `CDGMagic_MediaEvent` structure exactly:
```json
{
  "clips": [
    {
      "type": "BMPClip" | "TextClip",
      "track": number,
      "start": number,        // Packets (300 pps)
      "duration": number,     // Packets (300 pps)
      "events": [
        {
          "clip_time_offset": number,    // Offset within clip (packets)
          "clip_time_duration": number,  // Duration (packets)
          // ... clip-specific fields
        }
      ]
    }
  ]
}
```

---

## Reference File Relationships

### Test Data Files

| File | Type | Size | Duration | Purpose |
|------|------|------|----------|---------|
| `reference/cd+g-magic/Sample_Files/sample_project_04.cmp` | Binary project | — | — | **Source project** created in CD+Graphics Magic UI |
| `diag/sample_project_04.json` | JSON | — | — | **Extracted** from .cmp via `parse-cmp.ts` (artifact, must not modify) |
| `reference/cd+g-magic/Sample_Files/sample_project_04.cdg` | CDG binary | 432,000 bytes | 60.0 seconds | **Reference output** generated by CD+Graphics Magic |
| `diag/sample_project_04.cdg` | CDG binary | 302,400 bytes | 42.0 seconds | **Diag snapshot** (42s content + padding) |

### Duration Breakdown

The reference CDG is **60 seconds** because:
- Project content: ~42 seconds (last event ends at packet 12,110)
- Padding/black: ~18 seconds (to reach 18,000 packets total)

The diag version is **42 seconds** because:
- Project content: ~40.37 seconds (last event at 12,110 ÷ 300)
- Padding: ~1.6 seconds (to reach 12,600 packets at 300 pps)

Both are valid—the reference shows how the original software pads for audio alignment.

---

## Clip Types & Event Structure

### MediaEvent (Reference Struct)

From `CDGMagic_MediaClip.h`:

```cpp
struct CDGMagic_MediaEvent
{
    int start_offset;        // Offset within clip (packets)
    int duration;            // Duration (packets)
    int actual_start_offset; // Computed: clip_start + start_offset
    int actual_duration;     // Computed: max(duration, clip.duration)
    CDGMagic_PALObject *PALObject;
    CDGMagic_BMPObject *BMPObject;
    unsigned char border_index;
    unsigned char memory_preset_index;
    signed char x_scroll;
    signed char y_scroll;
    void *user_obj;
};
```

**Key Fields**:
- Times are **always in packets** (300 pps)
- `actual_start_offset` = `clip.start_pack() + start_offset` (global packet position)
- Both PALObject and BMPObject pointers coexist; palette events use PALObject

### Clip Types

#### 1. **BMPClip** (Bitmap/Image Clips)

**Purpose**: Render bitmap images at specific times with transitions

**Structure**:
```cpp
track: int                    // Audio track index
start: int                    // Clip start (packets)
duration: int                 // Clip duration (packets)
events: [
  {
    clip_time_offset: int     // When within clip (packets)
    clip_time_duration: int   // Display duration (packets)
    bmp_path: string          // Path to BMP file
    width: int                // BMP width in pixels
    height: int               // BMP height in pixels
    x_offset: int             // Screen X position
    y_offset: int             // Screen Y position
    fill_index: int           // Fill palette color index
    composite_index: int      // Composite palette index
    should_composite: bool    // Enable compositing
    border_index: int         // Border color index
    screen_index: int         // Screen index
    should_palette: bool      // Load palette before display
    transition_file: string   // Path to transition file (.cmt)
    transition_length: int    // Transition duration (packets)
  }
]
```

**Example from diag**:
```json
{
  "type": "BMPClip",
  "track": 0,
  "start": 600,           // 600 packets = 2.0 seconds
  "duration": 1479,       // 1479 packets = 4.93 seconds
  "events": [
    {
      "clip_time_offset": 0,
      "bmp_path": "Sample_Files\\simple_sky_2+14.bmp",
      "width": 216,
      "height": 300,
      "x_offset": 6,
      "y_offset": 12,
      "transition_file": "Sample_Files\\transition_gradient_03.cmt",
      "transition_length": 768  // 768 packets = 2.56 seconds
    }
  ]
}
```

#### 2. **TextClip** (Karaoke Text Clips)

**Purpose**: Display karaoke lyrics with syllable-level highlighting

**Structure**:
```cpp
track: int                      // Audio track index
start: int                      // Clip start (packets)
duration: int                   // Clip duration (packets)
font_face: string               // Font name (e.g., "BArial")
font_size: int                  // Font size in points
karaoke_mode: bool              // Enable karaoke highlighting
highlight_mode: int             // Highlighting style
foreground_color: int           // Text color palette index
background_color: int           // Background palette index
outline_color: int              // Outline color palette index
events: [
  {
    clip_time_offset: int       // Syllable start within clip (packets)
    clip_time_duration: int     // Highlight duration (packets)
    text_data: string           // Syllable text
    // ... additional text event fields
  }
]
```

---

## Configuration & Constants

### File Structure

#### CDG File Header/Setup (Packets 0–3)

**Packet 0**: Palette (LOAD CLUT0 - 16 color graphics mode)
- Command: 0x94 (Memory Preset)
- Loads initial color palette into graphics mode 0

**Packet 1**: Extended Palette (LOAD CLUT2 - 256 color graphics mode)
- Command: 0x94 (Memory Preset)
- Loads extended palette into graphics mode 2

**Packet 2–3**: Font Block Setup (if text is present)
- Command: 0x92 (Font Block)
- Initializes font data for text rendering

#### Subsequent Packets: Content Events

- **TILE BLOCK** (0x91): 6×12 character tile graphics
- **SCROLL PRESET** (0x98): Background properties and scrolling
- **PALETTE SET** (0x99): Color changes during playback
- **Other CDG commands** as needed for visual effects

### Memory Model

**VRAM Structure** (from CDGMagic_GraphicsEncoder.cpp):
```cpp
// VRAM: 300 × 216 pixels, indexed color (4-bit or 8-bit)
#define VRAM_WIDTH   300
#define VRAM_HEIGHT  216

// Pixel data stored as 16-bit values (index + flags)
unsigned short vram[VRAM_WIDTH * VRAM_HEIGHT];

// Tile dimension
#define TILE_WIDTH   6
#define TILE_HEIGHT  12

// Screen grid
#define SCREEN_COLS  50   // 300 ÷ 6
#define SCREEN_ROWS  18   // 216 ÷ 12
```

### Palette Model

**Graphics Mode 0 (16 colors)**:
- 4-bit color index (0–15)
- CLUT0 = color lookup table with 16 entries
- Typical: foreground=15 (white), background=0 (transparent)

**Graphics Mode 2 (256 colors)**:
- 8-bit color index (0–255)
- CLUT2 = color lookup table with 256 entries
- Used for extended palette effects

---

## Generation Pipeline

### Parser Output → Events → Packets

**Step 1: Parse JSON**
```
diag/sample_project_04.json → JSON structure with clips
```

**Step 2: Extract Clips**
```
For each clip:
  - Determine track and timing (start, duration in packets)
  - Load associated media (BMP files, font data)
  - Create events with exact packet positions
```

**Step 3: Build Events**
```
For BMPClip events:
  - Calculate global start packet = clip.start + event.clip_time_offset
  - Load BMP and render to 6×12 tile grid
  - Create TILE BLOCK commands at calculated packets

For TextClip events:
  - Extract syllable text and timing
  - Render text using CDG font
  - Create TILE BLOCK commands with palette highlighting
```

**Step 4: Initialize File**
```
Packet 0: LOAD CLUT0 (palette)
Packet 1: LOAD CLUT2 (extended)
Packet 2–3: FONT BLOCK (if needed)
Packets 4+: Content events (TILE, SCROLL, PALETTE, etc.)
```

**Step 5: Compute Duration**
```
Duration logic (priority):
  1. Explicit --duration-seconds CLI flag
  2. JSON "duration_seconds" or "duration_ms" field
  3. Computed from last event + 1s padding (default)
  
Result: CDG file padded to exact duration
  Size = (duration_seconds × 300) × 24 bytes
```

---

## Time Unit Interpretation Rules

### JSON Times

All numeric time fields in extracted JSON are in **packet units** (300 pps):

- `"start": 600` → 600 packets → 600 ÷ 300 = **2.0 seconds**
- `"duration": 1479` → 1479 packets → 1479 ÷ 300 = **4.93 seconds**
- `"clip_time_offset": 0` → offset within clip (packets)

### Conversion Function

From `src/cdg/utils.ts`:
```typescript
export function timeToPacks(value: number | undefined, pps = 300, timesInMs = false): number {
  if (value == null) return 0
  if (timesInMs) return msToPacks(value, pps)  // Convert ms → packets
  // Default: value is already in packet units
  return Math.floor(value)
}

export function msToPacks(ms: number, pps = 300): number {
  return Math.floor((ms / 1000) * pps)
}
```

**Key Rules**:
- By default, JSON times are **packet units** (no conversion needed)
- If times are in milliseconds (rare), use `timesInMs=true` to convert
- Never mix units within a single file—be explicit

---

## CDG Encoding Reference

### CDG Packet Format

All CDG packets are exactly **24 bytes**:

```
Byte 0–3:   Command and data
Byte 4–5:   Additional data (varies by command)
Byte 6–23:  Payload (tile data, palette data, etc.)
```

### Common Commands

| Command       | Code | Purpose                                         |
+---------------+------+-------------------------------------------------+
| Memory Preset | 0x94 | Select display mode, border color, clear screen |
| TILE BLOCK    | 0x91 | Display 6×12 character tile on screen           |
| SCROLL PRESET | 0x98 | Set scroll parameters                           |
| PALETTE SET   | 0x99 | Update color palette                            |
| FONT BLOCK    | 0x92 | Define font bitmap data                         |
| Keyframe      | 0x8C | Mark decoder reset point                        |
+---------------+------+-------------------------------------------------+

### Color Packing

**4-bit RGB (Graphics Mode 0)**:
```
Per-pixel: IIII (4-bit index into 16-color palette)
Palette entry: RRRR GGGG BBBB (12-bit RGB value)
Encoded as: 2 bytes = R|G|B|intensity
```

**From CDGPacket.ts (corrected formula)**:
```typescript
// Pack 4-bit RGBA to 2-byte CDG color
byte0 = r4
byte1 = ((g4 & 0x03) << 4) | b4
```

---

## Verification & Debugging

### File Size Check

```bash
# Calculate actual duration from CDG file
FILE_SIZE=$(stat -c%s output.cdg)
PACKETS=$((FILE_SIZE / 24))
SECONDS=$((PACKETS / 300))
echo "Generated: $PACKETS packets = $SECONDS seconds"
```

### Packet Inspection

**Tool**: `bin/inspect-cdg.cjs`

```bash
node bin/inspect-cdg.cjs output.cdg
# Shows:
#   - Total packet count
#   - Command distribution (palette, tile, etc.)
#   - First/last 32 packets in hex
#   - Color palette usage
```

### Event Tracing

**Tool**: `src/debug/find-event-for-block.ts`

```bash
npx tsx src/debug/find-event-for-block.ts <parsed.json> <packet_index>
# Finds which event created packet at given index
```

---

## References

### Key Source Files

- **Parser**: `src/debug/parse-cmp.ts` — Binary CMP extraction
- **Generator**: `src/debug/generate-cdg-from-json.ts` — Main CDG generation
- **Utils**: `src/cdg/utils.ts` — Time conversion and duration logic
- **Packet Format**: `src/karaoke/renderers/cdg/CDGPacket.ts` — Low-level CDG structures

### Reference Implementation

- **Location**: `reference/cd+g-magic/CDG_Magic/Source/`
- **Key Classes**:
  - `CDGMagic_MediaClip.h/.cpp` — Timing and event model
  - `CDGMagic_GraphicsEncoder.h/.cpp` — CDG packet generation
  - `CDGMagic_BMPClip.h/.cpp` — Bitmap rendering
  - `CDGMagic_TextClip.h/.cpp` — Text rendering

### Test Data

- **Project Source**: `reference/cd+g-magic/Sample_Files/sample_project_04.cmp`
- **Extracted JSON**: `diag/sample_project_04.json`
- **Reference Output**: `reference/cd+g-magic/Sample_Files/sample_project_04.cdg` (60s with padding)
- **Diag Snapshot**: `diag/sample_project_04.cdg` (42s content)

---

## Troubleshooting

### "Times don't match reference"

→ Verify time units: JSON times are **packets**, not milliseconds or seconds.  
→ Check conversion: `duration_seconds = packet_count / 300`

### "File size is wrong"

→ Verify target duration is correct: `expected_bytes = (target_seconds × 300) × 24`  
→ Check padding logic: is duration computed with enough padding?

### "Colors are wrong"

→ Verify palette encoding: use corrected formula with `((g4 & 0x03) << 4) | b4`  
→ Check palette initialization: first packet should be LOAD CLUT0

### "When in doubt"

→ **Always consult the reference code** in `reference/cd+g-magic/CDG_Magic/Source/`  
→ Run `bin/inspect-cdg.cjs` on both generated and reference CDG to compare  
→ Use `src/debug/parse-cmp.ts` to re-extract and verify JSON structure

---

## Quick Reference Table

| Concept            | Value          | Formula            | Example            |
+--------------------+----------------+--------------------+--------------------+
| CDG packet rate    | 300 pps        | —                  | —                  |
| Display frame rate | 75 fps         | —                  | —                  |
| Packets per frame  | 4              | 300 ÷ 75           | —                  |
| Packet size        | 24 bytes       | —                  | —                  |
| Tile size          | 6×12 px        | —                  | —                  |
| Screen grid        | 50×18 tiles    | (300÷6) × (216÷12) | —                  |
| 1 second           | 300 packets    | 1s × 300           | —                  |
| 1 minute           | 18,000 packets | 60s × 300          | —                  |
| Time from packets  | seconds        | packets ÷ 300      | 12,600 ÷ 300 = 42s |
| Time to packets    | packets        | seconds × 300      | 42s × 300 = 12,600 |
+--------------------+----------------+--------------------+--------------------+

---

## Reference Implementation Source Files

Located in `reference/cd+g-magic/CDG_Magic/Source/`, the following files comprise the CD+Graphics Magic application:

### Core Graphics Engine

- **CDGMagic_GraphicsEncoder.h/.cpp**

Main encoder that converts timeline clips into CDG packet stream. Contains `compute_graphics()` which iterates through all packets and schedules events at their start_pack times. Creates VRAM buffer and manages packet output.

- **CDGMagic_GraphicsEncoder__compositor.cpp**

Handles multi-layer rendering when clips overlap (8 compositing layers for different tracks). Blends overlapping tile data.

- **CDGMagic_GraphicsEncoder__write_fontblock.cpp**

Writes 6×12 tile font blocks to the packet stream. Handles both normal (COPY) and XOR rendering modes.

- **CDGMagic_GraphicsDecoder.h/.cpp**

Reads CDG packets and renders them to screen during playback. Used in preview window.

### Media Clip Types

- **CDGMagic_BMPClip.h/.cpp**

Represents image clips in timeline. Stores BMP file paths, positioning, transitions. Uses `duration(w() * 4)` to link visual width to packet timing.

- **CDGMagic_BMPClip_Window.h/.cpp**

Dialog for editing bitmap clip properties (position, transitions, timing).

- **CDGMagic_BMPLoader.h/.cpp**

Reads BMP files and extracts pixel data. Handles resize and interpolation.

- **CDGMagic_BMPObject.h/.cpp**

Converts loaded bitmap to 6×12 tile grid. Contains `CDGMagic_BMPObject__bilinear_resize.cpp` for resizing operations.

- **CDGMagic_TextClip.h/.cpp**

Stores font, size, color, highlighting mode, and syllable timing for karaoke text clips.

- **CDGMagic_TextClip_Window.h/.cpp**

Dialog for entering and editing karaoke text and syllable timings.

- **CDGMagic_TextClip_Window__Editor.cpp**

Implements syllable-level text entry with individual timing control.

- **CDGMagic_TextClip_Window__CtrlButton.cpp**

UI buttons for text clip operations.

- **CDGMagic_ScrollClip.h/.cpp**

Represents scrolling background clips. Experimental/not fully implemented.

- **CDGMagic_ScrollClip_Window.h/.cpp**

Editor for scroll clip properties.

- **CDGMagic_VectorClip_Window.h/.cpp**

Experimental line graphics mode support (not fully utilized).

- **CDGMagic_FontBlock.h/.cpp**

Data structure representing a single 6×12 tile with two colors and pixel bitmap. Supports both normal and XOR rendering modes.

### Media Model & Timeline

- **CDGMagic_MediaClip.h/.cpp**

Base class for all clips. Stores `start_pack`, `duration`, and event queue. Provides serialization for save/load operations.

- **CDGMagic_MediaClip.h** (MediaEvent structure)

Core event structure storing `start_offset`, `duration`, PALObject, BMPObject. Maps to internal timeline positions. Referenced in compute_graphics loop.

- **CDGMagic_EditingGroup.h/.cpp**

Timeline manager controlling all clips. Orchestrates `compute_graphics()` rendering and handles playback head position updates.

- **CDGMagic_EditingGroup_Callbacks.cpp**

Event handlers for clip operations (add BMP, add text, save CDG, playback control). Contains CDG file write logic via `fwrite(stream, cdg_gen->length(), sizeof(CD_SCPacket), CDG_File)`.

- **CDGMagic_EditingLanes.h/.cpp**

Visual timeline display showing clips on horizontal lanes with pixel-based positioning.

- **CDGMagic_EditingLanes_PlaybackHead.h/.cpp**

Playback cursor (red line) showing current playback position during preview and playback.

- **CDGMagic_MovableClipBox.h/.cpp**

Base class for visually movable clip boxes on the timeline.

### Palette & Color Management

- **CDGMagic_PALObject.h/.cpp**

Palette color object storing 16-color palette with optional fade/dissolve timing. Can interpolate colors over time for smooth transitions.

- **CDGMagic_PALGlobalClip.h/.cpp**

Special timeline clip for palette-only events (no graphics). Allows color changes independent of content.

- **CDGMagic_PALGlobalClip_Window.h/.cpp**

Dialog for editing global palette and color transitions.

- **CDGMagic_TrackOptions.h/.cpp**

Stores audio track selection, muting, and palette assignments per track.

- **CDGMagic_TrackOptions_MaskWindow.cpp**

UI for selecting which audio channels are active.

### Audio & Playback

- **CDGMagic_AudioPlayback.h/.cpp**

WAV audio engine that loads and plays WAV files, syncing with CDG timeline (147 audio samples = 1 CDG packet).

### UI & Application

- **CDGMagic_Application.h/.cpp**

Main application class managing lifecycle and global callbacks.

- **CDGMagic_Main.cpp**

Entry point creating CDGMagic_Application instance and running event loop.

- **CDGMagic_MainWindow.h/.cpp**

Top-level container for all editor UI (timeline, preview, controls).

- **CDGMagic_MainWindow_MenuBar.h/.cpp**

Menu bar providing File, Tools, Window, Help menus.

- **CDGMagic_MainWindow_MenuBar_MenuItems.h**

Defines menu items and callbacks (New, Open, Save, Export CDG).

- **CDGMagic_PreviewWindow.h/.cpp**

Shows CDG output in real-time. Uses GraphicsDecoder to render packets to screen.

- **CDGMagic_TimeOutput.h/.cpp**

Displays current playback time in MM:SS.FF format (minutes:seconds.frames at 75fps).

### Utilities

- **playback_head_xpm.h**

XPM image data containing pixel art for the playback head cursor icon.

### Key Architectural Insights

**Graphics Pipeline**

User places clips on timeline (BMPClip, TextClip, PALGlobalClip), each specifying `start_pack` and duration in packet units. CDGMagic_GraphicsEncoder.compute_graphics() iterates through ALL packets from 0 to duration, checking at each position if any MediaClip starts there. Events are queued (BMP→tile blocks, Text→font blocks, PAL→color loads) and the resulting font blocks and commands are written to CDG packet stream. The full stream is written to .cdg file, including all empty packets.

**Timing Model**

Events specify absolute start_pack (global position in file), and the encoder processes sequentially through the packet timeline. Empty packets naturally occur where no events are scheduled. This means **timing comes from project data, not inserted artificially**.

**Timeline Structure**

First clips may start after initial packets (e.g., at packet 600 in sample_project_04). The encoder outputs **all packets from 0 to max duration**. Packets 0-599 are empty because no events are scheduled there. Palette and memory presets are typically scheduled around the first clip start, with content events appearing at their specified packet times.

---

**Last Updated**: November 2025  
**Created to ensure**: Accurate understanding of CDG Magic semantics and generation pipeline