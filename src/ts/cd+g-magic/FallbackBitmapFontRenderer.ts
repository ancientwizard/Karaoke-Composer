/**
 * Fallback Bitmap Font Renderer
 *
 * Generates bitmap glyphs for CD+G text rendering.
 * Used as fallback when opentype.js fonts unavailable.
 * Provides scalable font for basic text output.
 *
 * Design:
 * - Base 6×12 glyph patterns (supports descenders and better letterforms)
 * - Variable height per glyph (dynamic detection)
 * - Scalable to any size via nearest-neighbor sampling
 * - ASCII printable characters (32-126, ~75 chars)
 * - Optimized for CD+G compatibility
 *
 * Baseline Semantics:
 * - Rows 0-4: Above baseline
 * - Row 5: Baseline (y=5 in 12-row grid)
 * - Rows 6-11: Below baseline (for descenders: y, p, q, g, j)
 * - Row 11 is the absolute bottom
 */

/**
 * Rendered glyph data
 */
export interface RenderedGlyph {
  width: number;
  height: number;
  data: Uint8Array;  // Bitmap pixel data (0-255)
  advanceWidth: number;
}

/**
 * Fallback bitmap font renderer
 */
export class FallbackBitmapFontRenderer {
  private fontSize: number = 12;
  private glyphCache = new Map<string, RenderedGlyph>();

  /**
   * 6×12 bitmap font for ASCII characters
   * Each character is 6 pixels wide × 12 pixels tall
   * Right-aligned: leading zeros are padding on the left
   * Baseline at y=5; descenders extend to y=11
   * 1 = filled, 0 = transparent
   * 
   * Source: CDGFont.ts - High-quality letterforms with proper typography
   * Features:
   * - Proper serifs and curves
   * - Correct descender positioning
   * - Proportional width (auto-trimmed)
   * - Better readability on low-res displays
   */
  private static readonly FONT_DATA: Record<string, number[]> = {
        ' ': [
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0
        ],
        '"': [
          0,0,0,1,0,1,
          0,0,0,1,0,1,
          0,0,0,1,0,1,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0
        ],
        '&': [
          0,0,0,0,0,0,
          0,0,1,1,1,0,
          0,1,0,0,0,1,
          0,1,0,0,0,1,
          0,0,1,1,1,0,
          0,1,0,0,1,0,
          0,1,0,1,0,1,
          0,0,1,0,1,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0
        ],
        '(': [
          0,0,0,0,0,0,
          0,0,0,0,0,1,
          0,0,0,0,1,0,
          0,0,0,0,1,0,
          0,0,0,0,1,0,
          0,0,0,0,1,0,
          0,0,0,0,1,0,
          0,0,0,0,0,1,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0
        ],
        ')': [
          0,0,0,0,0,0,
          0,0,0,0,1,0,
          0,0,0,0,0,1,
          0,0,0,0,0,1,
          0,0,0,0,0,1,
          0,0,0,0,0,1,
          0,0,0,0,0,1,
          0,0,0,0,1,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0
        ],
        '+': [
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,1,0,0,
          0,0,0,1,0,0,
          0,1,1,1,1,1,
          0,0,0,1,0,0,
          0,0,0,1,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0
        ],
        ',': [
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,1,
          0,0,0,0,1,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0
        ],
        '-': [
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,1,1,1,1,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0
        ],
        '.': [
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,1,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0
        ],
        '/': [
          0,0,0,0,0,0,
          0,0,0,0,0,1,
          0,0,0,0,1,0,
          0,0,0,0,1,0,
          0,0,0,1,0,0,
          0,0,0,1,0,0,
          0,0,1,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0
        ],
        '0': [
          0,0,0,0,0,0,
          0,0,1,1,1,0,
          0,1,0,0,0,1,
          0,1,0,0,1,1,
          0,1,0,1,0,1,
          0,1,1,0,0,1,
          0,1,0,0,0,1,
          0,0,1,1,1,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0
        ],
        '1': [
          0,0,0,0,0,0,
          0,0,0,0,1,0,
          0,0,0,1,1,0,
          0,0,0,0,1,0,
          0,0,0,0,1,0,
          0,0,0,0,1,0,
          0,0,0,1,1,1,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0
        ],
        '2': [
          0,0,0,0,0,0,
          0,0,1,1,1,0,
          0,1,0,0,0,1,
          0,0,0,0,0,1,
          0,0,0,0,1,0,
          0,0,0,1,0,0,
          0,0,1,0,0,0,
          0,1,1,1,1,1,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0
        ],
        '3': [
          0,0,0,0,0,0,
          0,1,1,1,1,1,
          0,0,0,0,0,1,
          0,0,0,0,1,0,
          0,0,1,1,1,0,
          0,0,0,0,0,1,
          0,1,0,0,0,1,
          0,0,1,1,1,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0
        ],
        '4': [
          0,0,0,0,0,0,
          0,0,0,0,1,0,
          0,0,0,1,1,0,
          0,0,1,0,1,0,
          0,1,0,0,1,0,
          0,1,1,1,1,1,
          0,0,0,0,1,0,
          0,0,0,0,1,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0
        ],
        '5': [
          0,0,0,0,0,0,
          0,1,1,1,1,1,
          0,1,0,0,0,0,
          0,1,1,1,1,0,
          0,0,0,0,0,1,
          0,0,0,0,0,1,
          0,1,0,0,0,1,
          0,0,1,1,1,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0
        ],
        '6': [
          0,0,0,0,0,0,
          0,0,1,1,1,0,
          0,1,0,0,0,1,
          0,1,0,0,0,0,
          0,1,1,1,1,0,
          0,1,0,0,0,1,
          0,1,0,0,0,1,
          0,0,1,1,1,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0
        ],
        '7': [
          0,0,0,0,0,0,
          0,1,1,1,1,1,
          0,0,0,0,0,1,
          0,0,0,0,1,0,
          0,0,0,1,0,0,
          0,0,0,1,0,0,
          0,0,1,0,0,0,
          0,0,1,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0
        ],
        '8': [
          0,0,0,0,0,0,
          0,0,1,1,1,0,
          0,1,0,0,0,1,
          0,1,0,0,0,1,
          0,0,1,1,1,0,
          0,1,0,0,0,1,
          0,1,0,0,0,1,
          0,0,1,1,1,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0
        ],
        '9': [
          0,0,0,0,0,0,
          0,0,1,1,1,0,
          0,1,0,0,0,1,
          0,1,0,0,0,1,
          0,0,1,1,1,1,
          0,0,0,0,0,1,
          0,1,0,0,0,1,
          0,0,1,1,1,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0
        ],
        ':': [
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,1,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,1,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0
        ],
        ';': [
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,1,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,1,
          0,0,0,0,1,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0
        ],
        '?': [
          0,0,0,0,0,0,
          0,0,0,1,1,0,
          0,0,1,0,0,1,
          0,0,0,0,0,1,
          0,0,0,0,1,0,
          0,0,0,1,0,0,
          0,0,0,0,0,0,
          0,0,0,1,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0
        ],
        'A': [
          0,0,0,0,0,0,
          0,0,0,1,1,0,
          0,0,1,0,0,1,
          0,0,1,0,0,1,
          0,0,1,1,1,1,
          0,0,1,0,0,1,
          0,0,1,0,0,1,
          0,0,1,0,0,1,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0
        ],
        'B': [
          0,0,0,0,0,0,
          0,0,1,1,1,0,
          0,0,1,0,0,1,
          0,0,1,0,0,1,
          0,0,1,1,1,0,
          0,0,1,0,0,1,
          0,0,1,0,0,1,
          0,0,1,1,1,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0
        ],
        'C': [
          0,0,0,0,0,0,
          0,0,0,1,1,0,
          0,0,1,0,0,1,
          0,0,1,0,0,0,
          0,0,1,0,0,0,
          0,0,1,0,0,0,
          0,0,1,0,0,1,
          0,0,0,1,1,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0
        ],
        'D': [
          0,0,0,0,0,0,
          0,0,1,1,1,0,
          0,0,1,0,0,1,
          0,0,1,0,0,1,
          0,0,1,0,0,1,
          0,0,1,0,0,1,
          0,0,1,0,0,1,
          0,0,1,1,1,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0
        ],
        'E': [
          0,0,0,0,0,0,
          0,0,1,1,1,1,
          0,0,1,0,0,0,
          0,0,1,0,0,0,
          0,0,1,1,1,0,
          0,0,1,0,0,0,
          0,0,1,0,0,0,
          0,0,1,1,1,1,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0
        ],
        'F': [
          0,0,0,0,0,0,
          0,0,1,1,1,1,
          0,0,1,0,0,0,
          0,0,1,0,0,0,
          0,0,1,1,1,0,
          0,0,1,0,0,0,
          0,0,1,0,0,0,
          0,0,1,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0
        ],
        'G': [
          0,0,0,0,0,0,
          0,0,0,1,1,0,
          0,0,1,0,0,1,
          0,0,1,0,0,0,
          0,0,1,0,1,1,
          0,0,1,0,0,1,
          0,0,1,0,0,1,
          0,0,0,1,1,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0
        ],
        'H': [
          0,0,0,0,0,0,
          0,0,1,0,0,1,
          0,0,1,0,0,1,
          0,0,1,0,0,1,
          0,0,1,1,1,1,
          0,0,1,0,0,1,
          0,0,1,0,0,1,
          0,0,1,0,0,1,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0
        ],
        'I': [
          0,0,0,0,0,0,
          0,0,0,1,1,1,
          0,0,0,0,1,0,
          0,0,0,0,1,0,
          0,0,0,0,1,0,
          0,0,0,0,1,0,
          0,0,0,0,1,0,
          0,0,0,1,1,1,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0
        ],
        'J': [
          0,0,0,0,0,0,
          0,0,0,1,1,1,
          0,0,0,0,1,0,
          0,0,0,0,1,0,
          0,0,0,0,1,0,
          0,0,0,0,1,0,
          0,0,1,0,1,0,
          0,0,1,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0
        ],
        'K': [
          0,0,0,0,0,0,
          0,1,0,0,0,1,
          0,1,0,0,1,0,
          0,1,0,1,0,0,
          0,1,1,0,0,0,
          0,1,0,1,0,0,
          0,1,0,0,1,0,
          0,1,0,0,0,1,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0
        ],
        'L': [
          0,0,0,0,0,0,
          0,0,0,1,0,0,
          0,0,0,1,0,0,
          0,0,0,1,0,0,
          0,0,0,1,0,0,
          0,0,0,1,0,0,
          0,0,0,1,0,0,
          0,0,0,1,1,1,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0
        ],
        'M': [
          0,0,0,0,0,0,
          0,1,0,0,0,1,
          0,1,1,0,1,1,
          0,1,0,1,0,1,
          0,1,0,1,0,1,
          0,1,0,0,0,1,
          0,1,0,0,0,1,
          0,1,0,0,0,1,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0
        ],
        'N': [
          0,0,0,0,0,0,
          0,0,1,0,0,1,
          0,0,1,0,0,1,
          0,0,1,0,0,1,
          0,0,1,1,0,1,
          0,0,1,0,1,1,
          0,0,1,0,0,1,
          0,0,1,0,0,1,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0
        ],
        'O': [
          0,0,0,0,0,0,
          0,0,0,1,1,0,
          0,0,1,0,0,1,
          0,0,1,0,0,1,
          0,0,1,0,0,1,
          0,0,1,0,0,1,
          0,0,1,0,0,1,
          0,0,0,1,1,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0
        ],
        'P': [
          0,0,0,0,0,0,
          0,0,1,1,1,0,
          0,0,1,0,0,1,
          0,0,1,0,0,1,
          0,0,1,1,1,0,
          0,0,1,0,0,0,
          0,0,1,0,0,0,
          0,0,1,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0
        ],
        'Q': [
          0,0,0,0,0,0,
          0,0,0,1,1,0,
          0,0,1,0,0,1,
          0,0,1,0,0,1,
          0,0,1,0,0,1,
          0,0,1,0,1,1,
          0,0,1,0,0,1,
          0,0,0,1,1,1,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0
        ],
        'R': [
          0,0,0,0,0,0,
          0,1,1,1,1,0,
          0,1,0,0,0,1,
          0,1,0,0,0,1,
          0,1,1,1,1,0,
          0,1,0,1,0,0,
          0,1,0,0,1,0,
          0,1,0,0,0,1,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0
        ],
        'S': [
          0,0,0,0,0,0,
          0,0,1,1,1,0,
          0,1,0,0,0,1,
          0,1,0,0,0,0,
          0,0,1,1,1,0,
          0,0,0,0,0,1,
          0,1,0,0,0,1,
          0,0,1,1,1,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0
        ],
        'T': [
          0,0,0,0,0,0,
          0,1,1,1,1,1,
          0,0,0,1,0,0,
          0,0,0,1,0,0,
          0,0,0,1,0,0,
          0,0,0,1,0,0,
          0,0,0,1,0,0,
          0,0,0,1,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0
        ],
        'U': [
          0,0,0,0,0,0,
          0,0,1,0,0,1,
          0,0,1,0,0,1,
          0,0,1,0,0,1,
          0,0,1,0,0,1,
          0,0,1,0,0,1,
          0,0,1,0,0,1,
          0,0,0,1,1,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0
        ],
        'V': [
          0,0,0,0,0,0,
          0,1,0,0,0,1,
          0,1,0,0,0,1,
          0,1,0,0,0,1,
          0,1,0,0,0,1,
          0,1,0,0,0,1,
          0,0,1,0,1,0,
          0,0,0,1,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0
        ],
        'W': [
          0,0,0,0,0,0,
          0,1,0,0,0,1,
          0,1,0,0,0,1,
          0,1,0,1,0,1,
          0,1,0,1,0,1,
          0,1,1,0,1,1,
          0,1,0,0,0,1,
          0,1,0,0,0,1,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0
        ],
        'X': [
          0,0,0,0,0,0,
          0,1,0,0,0,1,
          0,1,0,0,0,1,
          0,0,1,0,1,0,
          0,0,0,1,0,0,
          0,0,1,0,1,0,
          0,1,0,0,0,1,
          0,1,0,0,0,1,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0
        ],
        'Y': [
          0,0,0,0,0,0,
          0,1,0,0,0,1,
          0,1,0,0,0,1,
          0,0,1,0,1,0,
          0,0,0,1,0,0,
          0,0,0,1,0,0,
          0,0,0,1,0,0,
          0,0,0,1,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0
        ],
        'Z': [
          0,0,0,0,0,0,
          0,1,1,1,1,1,
          0,0,0,0,0,1,
          0,0,0,0,1,0,
          0,0,0,1,0,0,
          0,0,1,0,0,0,
          0,1,0,0,0,0,
          0,1,1,1,1,1,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0
        ],
        'a': [
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,1,1,0,
          0,0,0,0,0,1,
          0,0,0,1,1,1,
          0,0,1,0,0,1,
          0,0,0,1,1,1,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0
        ],
        'b': [
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,1,0,0,0,
          0,0,1,0,0,0,
          0,0,1,1,1,0,
          0,0,1,0,0,1,
          0,0,1,0,0,1,
          0,0,1,1,1,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0
        ],
        'c': [
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,1,1,
          0,0,0,1,0,0,
          0,0,0,1,0,0,
          0,0,0,1,0,0,
          0,0,0,0,1,1,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0
        ],
        'd': [
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,1,
          0,0,0,0,0,1,
          0,0,0,1,1,1,
          0,0,1,0,0,1,
          0,0,1,0,0,1,
          0,0,0,1,1,1,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0
        ],
        'e': [
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,1,1,0,
          0,0,1,0,0,1,
          0,0,1,1,1,1,
          0,0,1,0,0,0,
          0,0,0,1,1,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0
        ],
        'f': [
          0,0,0,0,0,0,
          0,0,0,0,1,1,
          0,0,0,1,0,0,
          0,0,1,1,1,0,
          0,0,0,1,0,0,
          0,0,0,1,0,0,
          0,0,0,1,0,0,
          0,0,0,1,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0
        ],
        'g': [
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,1,1,1,
          0,0,1,0,0,1,
          0,0,1,0,0,1,
          0,0,1,0,0,1,
          0,0,0,1,1,1,
          0,0,0,0,0,1,
          0,0,1,1,1,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0
        ],
        'h': [
          0,0,0,0,0,0,
          0,0,1,0,0,0,
          0,0,1,0,0,0,
          0,0,1,0,1,0,
          0,0,1,1,0,1,
          0,0,1,0,0,1,
          0,0,1,0,0,1,
          0,0,1,0,0,1,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0
        ],
        'i': [
          0,0,0,0,0,0,
          0,0,0,0,0,1,
          0,0,0,0,0,0,
          0,0,0,0,0,1,
          0,0,0,0,0,1,
          0,0,0,0,0,1,
          0,0,0,0,0,1,
          0,0,0,0,0,1,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0
        ],
        'j': [
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,1,
          0,0,0,0,0,0,
          0,0,0,0,0,1,
          0,0,0,0,0,1,
          0,0,0,0,0,1,
          0,0,0,0,1,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0
        ],
        'k': [
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,1,0,0,0,
          0,0,1,0,0,1,
          0,0,1,0,1,0,
          0,0,1,1,0,0,
          0,0,1,0,1,0,
          0,0,1,0,0,1,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0
        ],
        'l': [
          0,0,0,0,0,0,
          0,0,0,0,0,1,
          0,0,0,0,0,1,
          0,0,0,0,0,1,
          0,0,0,0,0,1,
          0,0,0,0,0,1,
          0,0,0,0,0,1,
          0,0,0,0,0,1,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0
        ],
        'm': [
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,1,0,1,0,
          0,1,0,1,0,1,
          0,1,0,1,0,1,
          0,1,0,1,0,1,
          0,1,0,1,0,1,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0
        ],
        'n': [
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,1,0,1,0,
          0,0,1,1,0,1,
          0,0,1,0,0,1,
          0,0,1,0,0,1,
          0,0,1,0,0,1,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0
        ],
        'o': [
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,1,1,0,
          0,0,1,0,0,1,
          0,0,1,0,0,1,
          0,0,1,0,0,1,
          0,0,0,1,1,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0
        ],
        'p': [
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,1,1,0,
          0,0,0,1,0,1,
          0,0,0,1,1,0,
          0,0,0,1,0,0,
          0,0,0,1,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0
        ],
        'q': [
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,1,1,
          0,0,0,1,0,1,
          0,0,0,1,0,1,
          0,0,0,1,0,1,
          0,0,0,0,1,1,
          0,0,0,0,0,1,
          0,0,0,0,0,1,
          0,0,0,0,0,0,
          0,0,0,0,0,0
        ],
        'r': [
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,1,0,1,
          0,0,0,1,1,0,
          0,0,0,1,0,0,
          0,0,0,1,0,0,
          0,0,0,1,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0
        ],
        's': [
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,1,1,0,
          0,0,1,0,0,0,
          0,0,0,1,1,0,
          0,0,0,0,0,1,
          0,0,0,1,1,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0
        ],
        't': [
          0,0,0,0,0,0,
          0,0,0,0,1,0,
          0,0,0,0,1,0,
          0,0,0,1,1,1,
          0,0,0,0,1,0,
          0,0,0,0,1,0,
          0,0,0,0,1,0,
          0,0,0,0,0,1,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0
        ],
        'u': [
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,1,0,0,1,
          0,0,1,0,0,1,
          0,0,1,0,0,1,
          0,0,1,0,1,1,
          0,0,0,1,0,1,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0
        ],
        'v': [
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,1,0,0,0,1,
          0,1,0,0,0,1,
          0,0,1,0,1,0,
          0,0,1,0,1,0,
          0,0,0,1,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0
        ],
        'w': [
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,1,0,0,0,1,
          0,1,0,1,0,1,
          0,1,0,1,0,1,
          0,1,1,0,1,1,
          0,1,0,0,0,1,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0
        ],
        'x': [
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,1,0,0,0,1,
          0,0,1,0,1,0,
          0,0,0,1,0,0,
          0,0,1,0,1,0,
          0,1,0,0,0,1,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0
        ],
        'y': [
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,1,0,1,
          0,0,0,1,0,1,
          0,0,0,1,0,1,
          0,0,0,0,1,1,
          0,0,0,0,0,1,
          0,0,0,1,1,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0
        ],
        'z': [
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,1,1,1,1,
          0,0,0,0,0,1,
          0,0,0,0,1,0,
          0,0,0,1,0,0,
          0,0,1,1,1,1,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0
        ],
  };
  /**
   * Set font size in points
   */
  setFontSize(size: number): void {
    this.fontSize = size;
    // Clear cache when size changes
    this.glyphCache.clear();
  }

  /**
   * Render a glyph to bitmap
   * @param char Character to render
   * @returns Rendered glyph with bitmap data, or null if no glyph available
   */
  renderGlyph(char: string): RenderedGlyph | null {
    // Check cache
    const cacheKey = `${char}@${this.fontSize}`;
    if (this.glyphCache.has(cacheKey)) {
      return this.glyphCache.get(cacheKey)!;
    }

    // Get base glyph data
    const baseGlyph = FallbackBitmapFontRenderer.FONT_DATA[char];
    
    if (!baseGlyph) {
      // Try uppercase version for lowercase letters
      const upperChar = char.toUpperCase();
      const upperGlyph = FallbackBitmapFontRenderer.FONT_DATA[upperChar];
      if (upperGlyph && upperGlyph !== baseGlyph) {
        return this.renderGlyph(upperChar);
      }
      // Unknown character - return space
      return this.renderGlyph(' ');
    }

    // Detect base dimensions from glyph array length
    // Format: 6 pixels per row, variable rows (typically 12)
    const baseWidth = 6;
    const baseHeight = Math.floor(baseGlyph.length / baseWidth);
    
    // Scale glyph to requested size
    // Base font is 12pt = 12 pixels height (6×12 glyphs)
    // Never render smaller than 12pt (1:1 scale)
    // Scale up proportionally for larger sizes
    // Use ceil() to ensure we don't lose pixels due to rounding
    const effectiveFontSize = Math.max(12, this.fontSize);
    const scale = Math.ceil(effectiveFontSize / 12);
    
    const scaledWidth = baseWidth * scale;
    const scaledHeight = baseHeight * scale;
    const bitmap = new Uint8Array(scaledWidth * scaledHeight);

    // Nearest-neighbor scaling
    for (let y = 0; y < scaledHeight; y++) {
      for (let x = 0; x < scaledWidth; x++) {
        const srcX = Math.floor(x / scale);
        const srcY = Math.floor(y / scale);
        const srcPixel = baseGlyph[srcY * baseWidth + srcX];
        bitmap[y * scaledWidth + x] = srcPixel ? 255 : 0;
      }
    }

    // Smart bounds detection: find actual glyph content
    let minX = scaledWidth;
    let maxX = -1;
    for (let y = 0; y < scaledHeight; y++) {
      for (let x = 0; x < scaledWidth; x++) {
        if (bitmap[y * scaledWidth + x]) {
          minX = Math.min(minX, x);
          maxX = Math.max(maxX, x);
        }
      }
    }

    // Extract trimmed glyph
    let actualWidth = scaledWidth;
    let trimmedData = bitmap;
    
    if (minX < scaledWidth && maxX >= 0) {
      actualWidth = maxX - minX + 1;
      trimmedData = new Uint8Array(actualWidth * scaledHeight);
      for (let y = 0; y < scaledHeight; y++) {
        for (let x = 0; x < actualWidth; x++) {
          trimmedData[y * actualWidth + x] = bitmap[y * scaledWidth + (minX + x)];
        }
      }
    }

    const result: RenderedGlyph = {
      width: actualWidth,
      height: scaledHeight,
      data: trimmedData,
      advanceWidth: Math.ceil(actualWidth * 1.2)  // Add small space between chars
    };

    // Cache it
    this.glyphCache.set(cacheKey, result);
    
    return result;
  }

  /**
   * Clear glyph cache
   */
  clearCache(): void {
    this.glyphCache.clear();
  }
}

// VIM: set ft=typescript :
// END
