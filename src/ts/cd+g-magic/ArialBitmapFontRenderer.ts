/**
 * Arial-like Bitmap Font Renderer
 *
 * Provides a higher-quality bitmap font that resembles Arial.
 * Uses wider character glyphs (7-8 pixels) compared to the fallback (5 pixels).
 * Better letter spacing and proportions for readable CD+G text.
 *
 * Design:
 * - Base 7×9 glyph pattern (wider than fallback 5×7)
 * - Better proportions for serif-free look
 * - Improved readability at larger sizes
 * - ASCII printable characters (32-126)
 */

export interface RenderedGlyph {
  width: number;
  height: number;
  data: Uint8Array;
  advanceWidth: number;
}

export class ArialBitmapFontRenderer {
  private fontSize: number = 12;
  private glyphCache = new Map<string, RenderedGlyph>();

  /**
   * 7×9 Arial-like bitmap font
   * Each character is 7 pixels wide × 9 pixels tall
   * More proportional than 5-pixel font
   */
  private static readonly FONT_DATA: Record<string, number[]> = {
    ' ': [0,0,0,0,0,0,0, 0,0,0,0,0,0,0, 0,0,0,0,0,0,0, 0,0,0,0,0,0,0, 0,0,0,0,0,0,0, 0,0,0,0,0,0,0, 0,0,0,0,0,0,0, 0,0,0,0,0,0,0, 0,0,0,0,0,0,0],
    'A': [0,0,1,1,1,0,0, 0,1,0,0,0,1,0, 0,1,0,0,0,1,0, 1,0,0,0,0,0,1, 1,1,1,1,1,1,1, 1,0,0,0,0,0,1, 1,0,0,0,0,0,1, 1,0,0,0,0,0,1, 1,0,0,0,0,0,1],
    'B': [1,1,1,1,1,1,0, 1,0,0,0,0,0,1, 1,0,0,0,0,0,1, 1,1,1,1,1,1,0, 1,0,0,0,0,0,1, 1,0,0,0,0,0,1, 1,0,0,0,0,0,1, 1,0,0,0,0,0,1, 1,1,1,1,1,1,0],
    'C': [0,1,1,1,1,1,1, 1,0,0,0,0,0,0, 1,0,0,0,0,0,0, 1,0,0,0,0,0,0, 1,0,0,0,0,0,0, 1,0,0,0,0,0,0, 1,0,0,0,0,0,0, 1,0,0,0,0,0,0, 0,1,1,1,1,1,1],
    'D': [1,1,1,1,1,1,0, 1,0,0,0,0,0,1, 1,0,0,0,0,0,1, 1,0,0,0,0,0,1, 1,0,0,0,0,0,1, 1,0,0,0,0,0,1, 1,0,0,0,0,0,1, 1,0,0,0,0,0,1, 1,1,1,1,1,1,0],
    'E': [1,1,1,1,1,1,1, 1,0,0,0,0,0,0, 1,0,0,0,0,0,0, 1,1,1,1,1,0,0, 1,0,0,0,0,0,0, 1,0,0,0,0,0,0, 1,0,0,0,0,0,0, 1,0,0,0,0,0,0, 1,1,1,1,1,1,1],
    'F': [1,1,1,1,1,1,1, 1,0,0,0,0,0,0, 1,0,0,0,0,0,0, 1,1,1,1,1,0,0, 1,0,0,0,0,0,0, 1,0,0,0,0,0,0, 1,0,0,0,0,0,0, 1,0,0,0,0,0,0, 1,0,0,0,0,0,0],
    'G': [0,1,1,1,1,1,1, 1,0,0,0,0,0,0, 1,0,0,0,0,0,0, 1,0,0,0,0,0,0, 1,0,0,1,1,1,1, 1,0,0,0,0,0,1, 1,0,0,0,0,0,1, 1,0,0,0,0,0,1, 0,1,1,1,1,1,1],
    'H': [1,0,0,0,0,0,1, 1,0,0,0,0,0,1, 1,0,0,0,0,0,1, 1,1,1,1,1,1,1, 1,0,0,0,0,0,1, 1,0,0,0,0,0,1, 1,0,0,0,0,0,1, 1,0,0,0,0,0,1, 1,0,0,0,0,0,1],
    'I': [0,1,1,1,1,1,0, 0,0,0,1,0,0,0, 0,0,0,1,0,0,0, 0,0,0,1,0,0,0, 0,0,0,1,0,0,0, 0,0,0,1,0,0,0, 0,0,0,1,0,0,0, 0,0,0,1,0,0,0, 0,1,1,1,1,1,0],
    'J': [0,1,1,1,1,1,0, 0,0,0,1,0,0,0, 0,0,0,1,0,0,0, 0,0,0,1,0,0,0, 0,0,0,1,0,0,0, 0,0,0,1,0,0,0, 1,0,0,1,0,0,0, 1,0,0,1,0,0,0, 0,1,1,1,0,0,0],
    'K': [1,0,0,0,0,0,1, 1,0,0,0,0,1,0, 1,0,0,0,1,0,0, 1,0,0,1,0,0,0, 1,1,1,0,0,0,0, 1,0,0,1,0,0,0, 1,0,0,0,1,0,0, 1,0,0,0,0,1,0, 1,0,0,0,0,0,1],
    'L': [1,0,0,0,0,0,0, 1,0,0,0,0,0,0, 1,0,0,0,0,0,0, 1,0,0,0,0,0,0, 1,0,0,0,0,0,0, 1,0,0,0,0,0,0, 1,0,0,0,0,0,0, 1,0,0,0,0,0,0, 1,1,1,1,1,1,1],
    'M': [1,0,0,0,0,0,1, 1,1,0,0,0,1,1, 1,0,1,0,1,0,1, 1,0,1,0,1,0,1, 1,0,0,1,0,0,1, 1,0,0,1,0,0,1, 1,0,0,0,0,0,1, 1,0,0,0,0,0,1, 1,0,0,0,0,0,1],
    'N': [1,0,0,0,0,0,1, 1,1,0,0,0,0,1, 1,0,1,0,0,0,1, 1,0,0,1,0,0,1, 1,0,0,0,1,0,1, 1,0,0,0,0,1,1, 1,0,0,0,0,0,1, 1,0,0,0,0,0,1, 1,0,0,0,0,0,1],
    'O': [0,1,1,1,1,1,0, 1,0,0,0,0,0,1, 1,0,0,0,0,0,1, 1,0,0,0,0,0,1, 1,0,0,0,0,0,1, 1,0,0,0,0,0,1, 1,0,0,0,0,0,1, 1,0,0,0,0,0,1, 0,1,1,1,1,1,0],
    'P': [1,1,1,1,1,1,0, 1,0,0,0,0,0,1, 1,0,0,0,0,0,1, 1,0,0,0,0,0,1, 1,1,1,1,1,1,0, 1,0,0,0,0,0,0, 1,0,0,0,0,0,0, 1,0,0,0,0,0,0, 1,0,0,0,0,0,0],
    'Q': [0,1,1,1,1,1,0, 1,0,0,0,0,0,1, 1,0,0,0,0,0,1, 1,0,0,0,0,0,1, 1,0,0,0,0,0,1, 1,0,0,0,0,0,1, 1,0,0,0,1,0,1, 1,0,0,0,0,1,1, 0,1,1,1,1,1,0],
    'R': [1,1,1,1,1,1,0, 1,0,0,0,0,0,1, 1,0,0,0,0,0,1, 1,0,0,0,0,0,1, 1,1,1,1,1,1,0, 1,0,0,0,1,0,0, 1,0,0,0,0,1,0, 1,0,0,0,0,0,1, 1,0,0,0,0,0,1],
    'S': [0,1,1,1,1,1,0, 1,0,0,0,0,0,1, 1,0,0,0,0,0,0, 0,1,0,0,0,0,0, 0,0,1,1,1,0,0, 0,0,0,0,0,1,0, 0,0,0,0,0,0,1, 1,0,0,0,0,0,1, 0,1,1,1,1,1,0],
    'T': [1,1,1,1,1,1,1, 0,0,0,1,0,0,0, 0,0,0,1,0,0,0, 0,0,0,1,0,0,0, 0,0,0,1,0,0,0, 0,0,0,1,0,0,0, 0,0,0,1,0,0,0, 0,0,0,1,0,0,0, 0,0,0,1,0,0,0],
    'U': [1,0,0,0,0,0,1, 1,0,0,0,0,0,1, 1,0,0,0,0,0,1, 1,0,0,0,0,0,1, 1,0,0,0,0,0,1, 1,0,0,0,0,0,1, 1,0,0,0,0,0,1, 1,0,0,0,0,0,1, 0,1,1,1,1,1,0],
    'V': [1,0,0,0,0,0,1, 1,0,0,0,0,0,1, 0,1,0,0,0,1,0, 0,1,0,0,0,1,0, 0,0,1,0,1,0,0, 0,0,1,0,1,0,0, 0,0,0,1,0,0,0, 0,0,0,1,0,0,0, 0,0,0,1,0,0,0],
    'W': [1,0,0,0,0,0,1, 1,0,0,0,0,0,1, 1,0,0,0,0,0,1, 1,0,0,1,0,0,1, 1,0,1,0,1,0,1, 1,0,1,0,1,0,1, 0,1,0,0,0,1,0, 0,1,0,0,0,1,0, 0,0,1,0,1,0,0],
    'X': [1,0,0,0,0,0,1, 0,1,0,0,0,1,0, 0,1,0,0,0,1,0, 0,0,1,0,1,0,0, 0,0,0,1,0,0,0, 0,0,1,0,1,0,0, 0,1,0,0,0,1,0, 0,1,0,0,0,1,0, 1,0,0,0,0,0,1],
    'Y': [1,0,0,0,0,0,1, 0,1,0,0,0,1,0, 0,0,1,0,1,0,0, 0,0,0,1,0,0,0, 0,0,0,1,0,0,0, 0,0,0,1,0,0,0, 0,0,0,1,0,0,0, 0,0,0,1,0,0,0, 0,0,0,1,0,0,0],
    'Z': [1,1,1,1,1,1,1, 0,0,0,0,0,0,1, 0,0,0,0,0,1,0, 0,0,0,0,1,0,0, 0,0,0,1,0,0,0, 0,0,1,0,0,0,0, 0,1,0,0,0,0,0, 1,0,0,0,0,0,0, 1,1,1,1,1,1,1],
    '0': [0,1,1,1,1,1,0, 1,0,0,0,0,0,1, 1,0,0,0,0,1,1, 1,0,0,0,1,0,1, 1,0,0,1,0,0,1, 1,0,1,0,0,0,1, 1,1,0,0,0,0,1, 1,0,0,0,0,0,1, 0,1,1,1,1,1,0],
    '1': [0,0,0,1,0,0,0, 0,0,1,1,0,0,0, 0,0,0,1,0,0,0, 0,0,0,1,0,0,0, 0,0,0,1,0,0,0, 0,0,0,1,0,0,0, 0,0,0,1,0,0,0, 0,0,0,1,0,0,0, 0,1,1,1,1,1,0],
    '2': [0,1,1,1,1,1,0, 1,0,0,0,0,0,1, 0,0,0,0,0,0,1, 0,0,0,0,0,1,0, 0,0,0,0,1,0,0, 0,0,0,1,0,0,0, 0,0,1,0,0,0,0, 0,1,0,0,0,0,0, 1,1,1,1,1,1,1],
    '3': [0,1,1,1,1,1,0, 1,0,0,0,0,0,1, 0,0,0,0,0,0,1, 0,0,0,1,1,1,0, 0,0,0,0,0,0,1, 0,0,0,0,0,0,1, 0,0,0,0,0,0,1, 1,0,0,0,0,0,1, 0,1,1,1,1,1,0],
    '4': [0,0,0,0,0,1,1, 0,0,0,0,1,0,1, 0,0,0,1,0,0,1, 0,0,1,0,0,0,1, 0,1,0,0,0,0,1, 1,1,1,1,1,1,1, 0,0,0,0,0,0,1, 0,0,0,0,0,0,1, 0,0,0,0,0,0,1],
    '5': [1,1,1,1,1,1,1, 1,0,0,0,0,0,0, 1,0,0,0,0,0,0, 1,1,1,1,1,1,0, 0,0,0,0,0,0,1, 0,0,0,0,0,0,1, 0,0,0,0,0,0,1, 1,0,0,0,0,0,1, 0,1,1,1,1,1,0],
    '6': [0,0,1,1,1,1,0, 0,1,0,0,0,0,0, 1,0,0,0,0,0,0, 1,1,1,1,1,1,0, 1,0,0,0,0,0,1, 1,0,0,0,0,0,1, 1,0,0,0,0,0,1, 1,0,0,0,0,0,1, 0,1,1,1,1,1,0],
    '7': [1,1,1,1,1,1,1, 0,0,0,0,0,0,1, 0,0,0,0,0,1,0, 0,0,0,0,1,0,0, 0,0,0,1,0,0,0, 0,0,1,0,0,0,0, 0,1,0,0,0,0,0, 0,1,0,0,0,0,0, 0,1,0,0,0,0,0],
    '8': [0,1,1,1,1,1,0, 1,0,0,0,0,0,1, 1,0,0,0,0,0,1, 0,1,1,1,1,1,0, 1,0,0,0,0,0,1, 1,0,0,0,0,0,1, 1,0,0,0,0,0,1, 1,0,0,0,0,0,1, 0,1,1,1,1,1,0],
    '9': [0,1,1,1,1,1,0, 1,0,0,0,0,0,1, 1,0,0,0,0,0,1, 1,0,0,0,0,0,1, 0,1,1,1,1,1,1, 0,0,0,0,0,0,1, 0,0,0,0,0,1,0, 0,0,0,0,1,0,0, 0,1,1,1,0,0,0],
  };

  setFontSize(size: number): void {
    this.fontSize = size;
    this.glyphCache.clear();
  }

  renderGlyph(char: string): RenderedGlyph | null {
    const cacheKey = `${char}@${this.fontSize}`;
    if (this.glyphCache.has(cacheKey)) {
      return this.glyphCache.get(cacheKey)!;
    }

    const glyphData = ArialBitmapFontRenderer.FONT_DATA[char.toUpperCase()] || 
                      ArialBitmapFontRenderer.FONT_DATA[' '];
    
    if (!glyphData) {
      return null;
    }

    // Scale factor: font size / base 9 pixels
    const scaleFactor = Math.max(1, this.fontSize / 9);
    const baseWidth = 7;
    const baseHeight = 9;
    const scaledWidth = Math.ceil(baseWidth * scaleFactor);
    const scaledHeight = Math.ceil(baseHeight * scaleFactor);

    // Create scaled bitmap
    const scaled = new Uint8Array(scaledWidth * scaledHeight);
    
    for (let sy = 0; sy < scaledHeight; sy++) {
      for (let sx = 0; sx < scaledWidth; sx++) {
        const srcX = Math.floor(sx / scaleFactor);
        const srcY = Math.floor(sy / scaleFactor);
        
        if (srcX < baseWidth && srcY < baseHeight) {
          const srcIdx = srcY * baseWidth + srcX;
          const dstIdx = sy * scaledWidth + sx;
          scaled[dstIdx] = glyphData[srcIdx] ? 255 : 0;
        }
      }
    }

    const result: RenderedGlyph = {
      width: scaledWidth,
      height: scaledHeight,
      data: scaled,
      advanceWidth: Math.ceil(scaledWidth + 1)  // Add 1 pixel spacing
    };

    this.glyphCache.set(cacheKey, result);
    return result;
  }

  clearCache(): void {
    this.glyphCache.clear();
  }
}

// VIM: set ft=typescript :
// END
